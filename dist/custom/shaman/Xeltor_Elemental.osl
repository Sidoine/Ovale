local __exports = LibStub:GetLibrary("ovale/scripts/ovale_shaman")
if not __exports then return end
__exports.registerShamanElementalXeltor = function(OvaleScripts)
do
	local name = "xeltor_elemental"
	local desc = "[Xel][8.3] Shaman: Elemental"
	local code = [[
Include(ovale_common)
Include(ovale_trinkets_mop)
Include(ovale_trinkets_wod)
Include(ovale_shaman_spells)

# Elemental
AddIcon specialization=1 help=main
{
	if not InCombat() and not target.IsFriend() and not mounted() and target.Present() and Speed() == 0
	{
		if TotemRemaining(totem_mastery_elemental) < 2 and not BuffPresent(ele_resonance_totem_buff) and Boss() Spell(totem_mastery_elemental)
	}

	# Interrupt
	if InCombat() InterruptActions()

	# Save ass
	# if not mounted() SaveActions()

	if target.InRange(lightning_bolt_elemental) and HasFullControl() and InCombat() and not target.DebuffPresent(crowd_control_debuff)
    {
		if PreviousGCDSpell(lava_burst) and not target.DebuffPresent(flame_shock_debuff) Spell(flame_shock)

		# Cooldowns
		if Boss() and { Speed() == 0 or BuffPresent(movement_allowed_buff) } defaultcdactions()

		# Short Cooldowns
		if Speed() == 0 or BuffPresent(movement_allowed_buff) defaultshortcdactions()

		# Default rotation
		if Speed() == 0 or BuffPresent(movement_allowed_buff) defaultmainactions()

		#lava_burst,moving=1,if=talent.ascendance.enabled
		if Speed() > 0 and Talent(ascendance_talent) Spell(lava_burst)
		#flame_shock,moving=1,target_if=refreshable
		if Speed() > 0 and target.Refreshable(flame_shock_debuff) Spell(flame_shock)
		#flame_shock,moving=1,if=movement.distance>6
		if Speed() > 0 and target.Distance() > 6 Spell(flame_shock)
		#frost_shock,moving=1
		if Speed() > 0 Spell(frost_shock)
	}
}

AddFunction InterruptActions
{
	if { target.HasManagedInterrupts() and target.MustBeInterrupted() } or { not target.HasManagedInterrupts() and target.IsInterruptible() }
	{
		if target.InRange(wind_shear) and target.IsInterruptible() Spell(wind_shear)
		if target.InRange(hex) and not target.Classification(worldboss) and target.RemainingCastTime() > CastTime(hex) + GCDRemaining() and target.CreatureType(Humanoid Beast) and Speed() == 0 Spell(hex)
		if target.Distance(less 5) and not target.Classification(worldboss) Spell(war_stomp)
		if target.InRange(quaking_palm) and not target.Classification(worldboss) Spell(quaking_palm)
		# if not target.Classification(worldboss) and target.RemainingCastTime() > 2 Spell(capacitor_totem)
	}
}

# AddFunction SaveActions
# {
# 	if HealthPercent() <= 50 and InCombat() Spell(astral_shift)
# 	if { Speed() == 0 or BuffPresent(movement_allowed_buff) } and HealthPercent() <= 50 and ManaPercent() > 25 and CanCast(healing_surge) and { not InCombat() or target.istargetingplayer() } Spell(healing_surge)
# 	if not BuffPresent(earth_shield_buff) and HealthPercent() < 100 and target.istargetingplayer() Spell(earth_shield)
# 	if target.istargetingplayer() and HealthPercent() < 50 Spell(earth_elemental)
# }

AddFunction elementaluseitemactions
{
	if Item(Trinket0Slot usable=1) Texture(inv_jewelry_talisman_12)
	if Item(Trinket1Slot usable=1) Texture(inv_jewelry_talisman_12)
}

### actions.default

AddFunction defaultmainactions
{
 #flame_shock,if=!ticking&spell_targets.chainlightning<4&(cooldown.storm_elemental.remains<cooldown.storm_elemental.duration-30|buff.wind_gust.stack<14)
 if not target.debuffpresent(flame_shock_debuff) and enemies(tagged=1) < 4 and { spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 or buffstacks(wind_gust_buff) < 14 } spell(flame_shock)
 #totem_mastery,if=talent.totem_mastery.enabled&buff.resonance_totem.remains<2
 if hastalent(totem_mastery_talent_elemental) and totemremaining(totem_mastery_elemental) < 2 spell(totem_mastery_elemental)
 #run_action_list,name=aoe,if=active_enemies>2&(spell_targets.chain_lightning>2|spell_targets.lava_beam>2)
 if enemies(tagged=1) > 2 and { enemies(tagged=1) > 2 or enemies(tagged=1) > 2 } elementalaoemainactions()

 unless enemies(tagged=1) > 2 and { enemies(tagged=1) > 2 or enemies(tagged=1) > 2 } and elementalaoemainpostconditions()
 {
  #run_action_list,name=funnel,if=active_enemies>=2&(spell_targets.chain_lightning<2|spell_targets.lava_beam<2)
  if enemies(tagged=1) >= 2 and { enemies(tagged=1) < 2 or enemies(tagged=1) < 2 } elementalfunnelmainactions()

  unless enemies(tagged=1) >= 2 and { enemies(tagged=1) < 2 or enemies(tagged=1) < 2 } and elementalfunnelmainpostconditions()
  {
   #run_action_list,name=single_target,if=active_enemies<=2
   if enemies(tagged=1) <= 2 shamanmainactions()
  }
 }
}

AddFunction defaultmainpostconditions
{
 enemies(tagged=1) > 2 and { enemies(tagged=1) > 2 or enemies(tagged=1) > 2 } and elementalaoemainpostconditions() or enemies(tagged=1) >= 2 and { enemies(tagged=1) < 2 or enemies(tagged=1) < 2 } and elementalfunnelmainpostconditions() or enemies(tagged=1) <= 2 and shamanmainpostconditions()
}

AddFunction defaultshortcdactions
{
 unless not target.debuffpresent(flame_shock_debuff) and enemies(tagged=1) < 4 and { spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 or buffstacks(wind_gust_buff) < 14 } and spell(flame_shock) or hastalent(totem_mastery_talent_elemental) and totemremaining(totem_mastery_elemental) < 2 and spell(totem_mastery_elemental)
 {
  #purifying_blast
  spell(purifying_blast)
  #the_unbound_force
  spell(the_unbound_force)
  #ripple_in_space
  spell(ripple_in_space_essence)
  #worldvein_resonance,if=(talent.unlimited_power.enabled|buff.stormkeeper.up|talent.ascendance.enabled&((talent.storm_elemental.enabled&cooldown.storm_elemental.remains<(cooldown.storm_elemental.duration-30)&cooldown.storm_elemental.remains>15|!talent.storm_elemental.enabled)&(!talent.icefury.enabled|!buff.icefury.up&!cooldown.icefury.up))|!cooldown.ascendance.up)
  if hastalent(unlimited_power_talent) or buffpresent(stormkeeper_buff) or hastalent(ascendance_talent) and { hastalent(storm_elemental_talent) and spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 and spellcooldown(storm_elemental) > 15 or not hastalent(storm_elemental_talent) } and { not hastalent(icefury_talent) or not buffpresent(icefury_buff) and not { not spellcooldown(icefury) > 0 } } or not { not spellcooldown(ascendance_elemental) > 0 } spell(worldvein_resonance_essence)
  #blood_of_the_enemy,if=talent.storm_elemental.enabled&pet.primal_storm_elemental.active
  if hastalent(storm_elemental_talent) and pet.present() spell(blood_of_the_enemy)
  #bag_of_tricks,if=!talent.ascendance.enabled|!buff.ascendance.up
  if not hastalent(ascendance_talent) or not buffpresent(ascendance_elemental_buff) spell(bag_of_tricks)
  #run_action_list,name=aoe,if=active_enemies>2&(spell_targets.chain_lightning>2|spell_targets.lava_beam>2)
  if enemies(tagged=1) > 2 and { enemies(tagged=1) > 2 or enemies(tagged=1) > 2 } elementalaoeshortcdactions()

  unless enemies(tagged=1) > 2 and { enemies(tagged=1) > 2 or enemies(tagged=1) > 2 } and elementalaoeshortcdpostconditions()
  {
   #run_action_list,name=funnel,if=active_enemies>=2&(spell_targets.chain_lightning<2|spell_targets.lava_beam<2)
   if enemies(tagged=1) >= 2 and { enemies(tagged=1) < 2 or enemies(tagged=1) < 2 } elementalfunnelshortcdactions()

   unless enemies(tagged=1) >= 2 and { enemies(tagged=1) < 2 or enemies(tagged=1) < 2 } and elementalfunnelshortcdpostconditions()
   {
    #run_action_list,name=single_target,if=active_enemies<=2
    if enemies(tagged=1) <= 2 shamanshortcdactions()
   }
  }
 }
}

AddFunction defaultshortcdpostconditions
{
 not target.debuffpresent(flame_shock_debuff) and enemies(tagged=1) < 4 and { spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 or buffstacks(wind_gust_buff) < 14 } and spell(flame_shock) or hastalent(totem_mastery_talent_elemental) and totemremaining(totem_mastery_elemental) < 2 and spell(totem_mastery_elemental) or enemies(tagged=1) > 2 and { enemies(tagged=1) > 2 or enemies(tagged=1) > 2 } and elementalaoeshortcdpostconditions() or enemies(tagged=1) >= 2 and { enemies(tagged=1) < 2 or enemies(tagged=1) < 2 } and elementalfunnelshortcdpostconditions() or enemies(tagged=1) <= 2 and shamanshortcdpostconditions()
}

AddFunction defaultcdactions
{
 # elementalinterruptactions()

 unless not target.debuffpresent(flame_shock_debuff) and enemies(tagged=1) < 4 and { spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 or buffstacks(wind_gust_buff) < 14 } and spell(flame_shock) or hastalent(totem_mastery_talent_elemental) and totemremaining(totem_mastery_elemental) < 2 and spell(totem_mastery_elemental)
 {
  #use_items
  elementaluseitemactions()
  #guardian_of_azeroth,if=dot.flame_shock.ticking&(!talent.storm_elemental.enabled&(cooldown.fire_elemental.duration-30<cooldown.fire_elemental.remains|expected_combat_length-time>190|expected_combat_length-time<32|!(cooldown.fire_elemental.remains+30<expected_combat_length-time)|cooldown.fire_elemental.remains<2)|talent.storm_elemental.enabled&(cooldown.storm_elemental.duration-30<cooldown.storm_elemental.remains|expected_combat_length-time>190|expected_combat_length-time<35|!(cooldown.storm_elemental.remains+30<expected_combat_length-time)|cooldown.storm_elemental.remains<2))
  if target.debuffpresent(flame_shock_debuff) and { not hastalent(storm_elemental_talent) and { spellcooldownduration(fire_elemental) - 30 < spellcooldown(fire_elemental) or 600 - timeincombat() > 190 or 600 - timeincombat() < 32 or not spellcooldown(fire_elemental) + 30 < 600 - timeincombat() or spellcooldown(fire_elemental) < 2 } or hastalent(storm_elemental_talent) and { spellcooldownduration(storm_elemental) - 30 < spellcooldown(storm_elemental) or 600 - timeincombat() > 190 or 600 - timeincombat() < 35 or not spellcooldown(storm_elemental) + 30 < 600 - timeincombat() or spellcooldown(storm_elemental) < 2 } } spell(guardian_of_azeroth)
  #fire_elemental,if=!talent.storm_elemental.enabled&(!essence.condensed_lifeforce.major|cooldown.guardian_of_azeroth.remains>150|expected_combat_length-time<30|expected_combat_length-time<60|expected_combat_length-time>155|!(cooldown.guardian_of_azeroth.remains+30<expected_combat_length-time))
  if not hastalent(storm_elemental_talent) and { not azeriteessenceismajor(condensed_life_force_essence_id) or spellcooldown(guardian_of_azeroth) > 150 or 600 - timeincombat() < 30 or 600 - timeincombat() < 60 or 600 - timeincombat() > 155 or not spellcooldown(guardian_of_azeroth) + 30 < 600 - timeincombat() } spell(fire_elemental)
  #focused_azerite_beam
  spell(focused_azerite_beam)

  unless spell(purifying_blast) or spell(the_unbound_force)
  {
   #memory_of_lucid_dreams
   spell(memory_of_lucid_dreams_essence)

   unless spell(ripple_in_space_essence) or { hastalent(unlimited_power_talent) or buffpresent(stormkeeper_buff) or hastalent(ascendance_talent) and { hastalent(storm_elemental_talent) and spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 and spellcooldown(storm_elemental) > 15 or not hastalent(storm_elemental_talent) } and { not hastalent(icefury_talent) or not buffpresent(icefury_buff) and not { not spellcooldown(icefury) > 0 } } or not { not spellcooldown(ascendance_elemental) > 0 } } and spell(worldvein_resonance_essence)
   {
    #storm_elemental,if=talent.storm_elemental.enabled&(!cooldown.stormkeeper.up|!talent.stormkeeper.enabled)&(!talent.icefury.enabled|!buff.icefury.up&!cooldown.icefury.up)&(!talent.ascendance.enabled|!buff.ascendance.up|expected_combat_length-time<32)&(!essence.condensed_lifeforce.major|cooldown.guardian_of_azeroth.remains>150|expected_combat_length-time<30|expected_combat_length-time<60|expected_combat_length-time>155|!(cooldown.guardian_of_azeroth.remains+30<expected_combat_length-time))
    if hastalent(storm_elemental_talent) and { not { not spellcooldown(stormkeeper) > 0 } or not hastalent(stormkeeper_talent) } and { not hastalent(icefury_talent) or not buffpresent(icefury_buff) and not { not spellcooldown(icefury) > 0 } } and { not hastalent(ascendance_talent) or not buffpresent(ascendance_elemental_buff) or 600 - timeincombat() < 32 } and { not azeriteessenceismajor(condensed_life_force_essence_id) or spellcooldown(guardian_of_azeroth) > 150 or 600 - timeincombat() < 30 or 600 - timeincombat() < 60 or 600 - timeincombat() > 155 or not spellcooldown(guardian_of_azeroth) + 30 < 600 - timeincombat() } spell(storm_elemental)
    #blood_fury,if=!talent.ascendance.enabled|buff.ascendance.up|cooldown.ascendance.remains>50
    if not hastalent(ascendance_talent) or buffpresent(ascendance_elemental_buff) or spellcooldown(ascendance_elemental) > 50 spell(blood_fury_apsp)
    #berserking,if=!talent.ascendance.enabled|buff.ascendance.up
    if not hastalent(ascendance_talent) or buffpresent(ascendance_elemental_buff) spell(berserking)
    #fireblood,if=!talent.ascendance.enabled|buff.ascendance.up|cooldown.ascendance.remains>50
    if not hastalent(ascendance_talent) or buffpresent(ascendance_elemental_buff) or spellcooldown(ascendance_elemental) > 50 spell(fireblood)
    #ancestral_call,if=!talent.ascendance.enabled|buff.ascendance.up|cooldown.ascendance.remains>50
    if not hastalent(ascendance_talent) or buffpresent(ascendance_elemental_buff) or spellcooldown(ascendance_elemental) > 50 spell(ancestral_call)

    unless { not hastalent(ascendance_talent) or not buffpresent(ascendance_elemental_buff) } and spell(bag_of_tricks)
    {
     #run_action_list,name=aoe,if=active_enemies>2&(spell_targets.chain_lightning>2|spell_targets.lava_beam>2)
     if enemies(tagged=1) > 2 and { enemies(tagged=1) > 2 or enemies(tagged=1) > 2 } elementalaoecdactions()

     unless enemies(tagged=1) > 2 and { enemies(tagged=1) > 2 or enemies(tagged=1) > 2 } and elementalaoecdpostconditions()
     {
      #run_action_list,name=funnel,if=active_enemies>=2&(spell_targets.chain_lightning<2|spell_targets.lava_beam<2)
      if enemies(tagged=1) >= 2 and { enemies(tagged=1) < 2 or enemies(tagged=1) < 2 } elementalfunnelcdactions()

      unless enemies(tagged=1) >= 2 and { enemies(tagged=1) < 2 or enemies(tagged=1) < 2 } and elementalfunnelcdpostconditions()
      {
       #run_action_list,name=single_target,if=active_enemies<=2
       if enemies(tagged=1) <= 2 shamancdactions()
      }
     }
    }
   }
  }
 }
}

AddFunction defaultcdpostconditions
{
 not target.debuffpresent(flame_shock_debuff) and enemies(tagged=1) < 4 and { spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 or buffstacks(wind_gust_buff) < 14 } and spell(flame_shock) or hastalent(totem_mastery_talent_elemental) and totemremaining(totem_mastery_elemental) < 2 and spell(totem_mastery_elemental) or spell(purifying_blast) or spell(the_unbound_force) or spell(ripple_in_space_essence) or { hastalent(unlimited_power_talent) or buffpresent(stormkeeper_buff) or hastalent(ascendance_talent) and { hastalent(storm_elemental_talent) and spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 and spellcooldown(storm_elemental) > 15 or not hastalent(storm_elemental_talent) } and { not hastalent(icefury_talent) or not buffpresent(icefury_buff) and not { not spellcooldown(icefury) > 0 } } or not { not spellcooldown(ascendance_elemental) > 0 } } and spell(worldvein_resonance_essence) or { not hastalent(ascendance_talent) or not buffpresent(ascendance_elemental_buff) } and spell(bag_of_tricks) or enemies(tagged=1) > 2 and { enemies(tagged=1) > 2 or enemies(tagged=1) > 2 } and elementalaoecdpostconditions() or enemies(tagged=1) >= 2 and { enemies(tagged=1) < 2 or enemies(tagged=1) < 2 } and elementalfunnelcdpostconditions() or enemies(tagged=1) <= 2 and shamancdpostconditions()
}

### actions.aoe

AddFunction elementalaoemainactions
{
 #flame_shock,target_if=refreshable&(spell_targets.chain_lightning<(5-!talent.totem_mastery.enabled)|!talent.storm_elemental.enabled&(cooldown.fire_elemental.remains>(cooldown.storm_elemental.duration-30+14*spell_haste)|cooldown.fire_elemental.remains<(24-14*spell_haste)))&(!talent.storm_elemental.enabled|cooldown.storm_elemental.remains<(cooldown.storm_elemental.duration-30)|spell_targets.chain_lightning=3&buff.wind_gust.stack<14)
 if target.refreshable(flame_shock_debuff) and { enemies(tagged=1) < 5 - hastalent(totem_mastery_talent_elemental no) or not hastalent(storm_elemental_talent) and { spellcooldown(fire_elemental) > spellcooldownduration(storm_elemental) - 30 + 14 * { 100 / { 100 + spellcastspeedpercent() } } or spellcooldown(fire_elemental) < 24 - 14 * { 100 / { 100 + spellcastspeedpercent() } } } } and { not hastalent(storm_elemental_talent) or spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 or enemies(tagged=1) == 3 and buffstacks(wind_gust_buff) < 14 } spell(flame_shock)
 #earthquake,if=!talent.master_of_the_elements.enabled|buff.stormkeeper.up|maelstrom>=(100-4*spell_targets.chain_lightning)|buff.master_of_the_elements.up|spell_targets.chain_lightning>3
 if not hastalent(master_of_the_elements_talent) or buffpresent(stormkeeper_buff) or maelstrom() >= 100 - 4 * enemies(tagged=1) or buffpresent(master_of_the_elements_buff) or enemies(tagged=1) > 3 spell(earthquake)
 #chain_lightning,if=buff.stormkeeper.remains<3*gcd*buff.stormkeeper.stack
 if buffremaining(stormkeeper_buff) < 3 * gcd() * buffstacks(stormkeeper_buff) spell(chain_lightning_elemental)
 #lava_burst,if=buff.lava_surge.up&spell_targets.chain_lightning<4&(!talent.storm_elemental.enabled|cooldown.storm_elemental.remains<(cooldown.storm_elemental.duration-30))&dot.flame_shock.ticking
 if buffpresent(lava_surge_buff) and enemies(tagged=1) < 4 and { not hastalent(storm_elemental_talent) or spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 } and target.debuffpresent(flame_shock_debuff) spell(lava_burst)
 #frost_shock,if=spell_targets.chain_lightning<4&buff.icefury.up&!buff.ascendance.up
 if enemies(tagged=1) < 4 and buffpresent(icefury_buff) and not buffpresent(ascendance_elemental_buff) spell(frost_shock)
 #elemental_blast,if=talent.elemental_blast.enabled&spell_targets.chain_lightning<4&(!talent.storm_elemental.enabled|cooldown.storm_elemental.remains<(cooldown.storm_elemental.duration-30))
 if hastalent(elemental_blast_talent) and enemies(tagged=1) < 4 and { not hastalent(storm_elemental_talent) or spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 } spell(elemental_blast)
 #lava_beam,if=talent.ascendance.enabled
 if hastalent(ascendance_talent) spell(lava_beam)
 #chain_lightning
 spell(chain_lightning_elemental)
 #lava_burst,moving=1,if=talent.ascendance.enabled
 if speed() > 0 and hastalent(ascendance_talent) spell(lava_burst)
 #flame_shock,moving=1,target_if=refreshable
 if speed() > 0 and target.refreshable(flame_shock_debuff) spell(flame_shock)
 #frost_shock,moving=1
 if speed() > 0 spell(frost_shock)
}

AddFunction elementalaoemainpostconditions
{
}

AddFunction elementalaoeshortcdactions
{
 #stormkeeper,if=talent.stormkeeper.enabled
 if hastalent(stormkeeper_talent) spell(stormkeeper)

 unless target.refreshable(flame_shock_debuff) and { enemies(tagged=1) < 5 - hastalent(totem_mastery_talent_elemental no) or not hastalent(storm_elemental_talent) and { spellcooldown(fire_elemental) > spellcooldownduration(storm_elemental) - 30 + 14 * { 100 / { 100 + spellcastspeedpercent() } } or spellcooldown(fire_elemental) < 24 - 14 * { 100 / { 100 + spellcastspeedpercent() } } } } and { not hastalent(storm_elemental_talent) or spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 or enemies(tagged=1) == 3 and buffstacks(wind_gust_buff) < 14 } and spell(flame_shock)
 {
  #liquid_magma_totem,if=talent.liquid_magma_totem.enabled
  if hastalent(liquid_magma_totem_talent) spell(liquid_magma_totem)

  unless { not hastalent(master_of_the_elements_talent) or buffpresent(stormkeeper_buff) or maelstrom() >= 100 - 4 * enemies(tagged=1) or buffpresent(master_of_the_elements_buff) or enemies(tagged=1) > 3 } and spell(earthquake)
  {
   #blood_of_the_enemy,if=!talent.primal_elementalist.enabled|!talent.storm_elemental.enabled
   if not hastalent(primal_elementalist_talent) or not hastalent(storm_elemental_talent) spell(blood_of_the_enemy)

   unless buffremaining(stormkeeper_buff) < 3 * gcd() * buffstacks(stormkeeper_buff) and spell(chain_lightning_elemental) or buffpresent(lava_surge_buff) and enemies(tagged=1) < 4 and { not hastalent(storm_elemental_talent) or spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 } and target.debuffpresent(flame_shock_debuff) and spell(lava_burst)
   {
    #icefury,if=spell_targets.chain_lightning<4&!buff.ascendance.up
    if enemies(tagged=1) < 4 and not buffpresent(ascendance_elemental_buff) spell(icefury)
   }
  }
 }
}

AddFunction elementalaoeshortcdpostconditions
{
 target.refreshable(flame_shock_debuff) and { enemies(tagged=1) < 5 - hastalent(totem_mastery_talent_elemental no) or not hastalent(storm_elemental_talent) and { spellcooldown(fire_elemental) > spellcooldownduration(storm_elemental) - 30 + 14 * { 100 / { 100 + spellcastspeedpercent() } } or spellcooldown(fire_elemental) < 24 - 14 * { 100 / { 100 + spellcastspeedpercent() } } } } and { not hastalent(storm_elemental_talent) or spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 or enemies(tagged=1) == 3 and buffstacks(wind_gust_buff) < 14 } and spell(flame_shock) or { not hastalent(master_of_the_elements_talent) or buffpresent(stormkeeper_buff) or maelstrom() >= 100 - 4 * enemies(tagged=1) or buffpresent(master_of_the_elements_buff) or enemies(tagged=1) > 3 } and spell(earthquake) or buffremaining(stormkeeper_buff) < 3 * gcd() * buffstacks(stormkeeper_buff) and spell(chain_lightning_elemental) or buffpresent(lava_surge_buff) and enemies(tagged=1) < 4 and { not hastalent(storm_elemental_talent) or spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 } and target.debuffpresent(flame_shock_debuff) and spell(lava_burst) or enemies(tagged=1) < 4 and buffpresent(icefury_buff) and not buffpresent(ascendance_elemental_buff) and spell(frost_shock) or hastalent(elemental_blast_talent) and enemies(tagged=1) < 4 and { not hastalent(storm_elemental_talent) or spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 } and spell(elemental_blast) or hastalent(ascendance_talent) and spell(lava_beam) or spell(chain_lightning_elemental) or speed() > 0 and hastalent(ascendance_talent) and spell(lava_burst) or speed() > 0 and target.refreshable(flame_shock_debuff) and spell(flame_shock) or speed() > 0 and spell(frost_shock)
}

AddFunction elementalaoecdactions
{
 unless hastalent(stormkeeper_talent) and spell(stormkeeper) or target.refreshable(flame_shock_debuff) and { enemies(tagged=1) < 5 - hastalent(totem_mastery_talent_elemental no) or not hastalent(storm_elemental_talent) and { spellcooldown(fire_elemental) > spellcooldownduration(storm_elemental) - 30 + 14 * { 100 / { 100 + spellcastspeedpercent() } } or spellcooldown(fire_elemental) < 24 - 14 * { 100 / { 100 + spellcastspeedpercent() } } } } and { not hastalent(storm_elemental_talent) or spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 or enemies(tagged=1) == 3 and buffstacks(wind_gust_buff) < 14 } and spell(flame_shock)
 {
  #ascendance,if=talent.ascendance.enabled&(talent.storm_elemental.enabled&cooldown.storm_elemental.remains<(cooldown.storm_elemental.duration-30)&cooldown.storm_elemental.remains>15|!talent.storm_elemental.enabled)&(!talent.icefury.enabled|!buff.icefury.up&!cooldown.icefury.up)
  if hastalent(ascendance_talent) and { hastalent(storm_elemental_talent) and spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 and spellcooldown(storm_elemental) > 15 or not hastalent(storm_elemental_talent) } and { not hastalent(icefury_talent) or not buffpresent(icefury_buff) and not { not spellcooldown(icefury) > 0 } } and buffexpires(ascendance_elemental_buff) spell(ascendance_elemental)
 }
}

AddFunction elementalaoecdpostconditions
{
 hastalent(stormkeeper_talent) and spell(stormkeeper) or target.refreshable(flame_shock_debuff) and { enemies(tagged=1) < 5 - hastalent(totem_mastery_talent_elemental no) or not hastalent(storm_elemental_talent) and { spellcooldown(fire_elemental) > spellcooldownduration(storm_elemental) - 30 + 14 * { 100 / { 100 + spellcastspeedpercent() } } or spellcooldown(fire_elemental) < 24 - 14 * { 100 / { 100 + spellcastspeedpercent() } } } } and { not hastalent(storm_elemental_talent) or spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 or enemies(tagged=1) == 3 and buffstacks(wind_gust_buff) < 14 } and spell(flame_shock) or hastalent(liquid_magma_totem_talent) and spell(liquid_magma_totem) or { not hastalent(master_of_the_elements_talent) or buffpresent(stormkeeper_buff) or maelstrom() >= 100 - 4 * enemies(tagged=1) or buffpresent(master_of_the_elements_buff) or enemies(tagged=1) > 3 } and spell(earthquake) or buffremaining(stormkeeper_buff) < 3 * gcd() * buffstacks(stormkeeper_buff) and spell(chain_lightning_elemental) or buffpresent(lava_surge_buff) and enemies(tagged=1) < 4 and { not hastalent(storm_elemental_talent) or spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 } and target.debuffpresent(flame_shock_debuff) and spell(lava_burst) or enemies(tagged=1) < 4 and not buffpresent(ascendance_elemental_buff) and spell(icefury) or enemies(tagged=1) < 4 and buffpresent(icefury_buff) and not buffpresent(ascendance_elemental_buff) and spell(frost_shock) or hastalent(elemental_blast_talent) and enemies(tagged=1) < 4 and { not hastalent(storm_elemental_talent) or spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 } and spell(elemental_blast) or hastalent(ascendance_talent) and spell(lava_beam) or spell(chain_lightning_elemental) or speed() > 0 and hastalent(ascendance_talent) and spell(lava_burst) or speed() > 0 and target.refreshable(flame_shock_debuff) and spell(flame_shock) or speed() > 0 and spell(frost_shock)
}

### actions.funnel

AddFunction elementalfunnelmainactions
{
 #flame_shock,target_if=(!ticking|dot.flame_shock.remains<=gcd|talent.ascendance.enabled&dot.flame_shock.remains<(cooldown.ascendance.remains+buff.ascendance.duration)&cooldown.ascendance.remains<4&(!talent.storm_elemental.enabled|talent.storm_elemental.enabled&cooldown.storm_elemental.remains<120))&(buff.wind_gust.stack<14|azerite.igneous_potential.rank>=2|buff.lava_surge.up|!buff.bloodlust.up)&!buff.surge_of_power.up
 if { not target.debuffpresent(flame_shock_debuff) or target.debuffremaining(flame_shock_debuff) <= gcd() or hastalent(ascendance_talent) and target.debuffremaining(flame_shock_debuff) < spellcooldown(ascendance_elemental) + baseduration(ascendance_elemental_buff) and spellcooldown(ascendance_elemental) < 4 and { not hastalent(storm_elemental_talent) or hastalent(storm_elemental_talent) and spellcooldown(storm_elemental) < 120 } } and { buffstacks(wind_gust_buff) < 14 or azeritetraitrank(igneous_potential_trait) >= 2 or buffpresent(lava_surge_buff) or not buffpresent(burst_haste_buff_buff) } and not buffpresent(surge_of_power_buff) spell(flame_shock)
 #elemental_blast,if=talent.elemental_blast.enabled&(talent.master_of_the_elements.enabled&buff.master_of_the_elements.up&maelstrom<60|!talent.master_of_the_elements.enabled)&(!(cooldown.storm_elemental.remains>(cooldown.storm_elemental.duration-30)&talent.storm_elemental.enabled)|azerite.natural_harmony.rank=3&buff.wind_gust.stack<14)
 if hastalent(elemental_blast_talent) and { hastalent(master_of_the_elements_talent) and buffpresent(master_of_the_elements_buff) and maelstrom() < 60 or not hastalent(master_of_the_elements_talent) } and { not { spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) } or azeritetraitrank(natural_harmony_trait) == 3 and buffstacks(wind_gust_buff) < 14 } spell(elemental_blast)
 #lightning_bolt,if=buff.stormkeeper.up&spell_targets.chain_lightning<6&(azerite.lava_shock.rank*buff.lava_shock.stack)<36&(buff.master_of_the_elements.up&!talent.surge_of_power.enabled|buff.surge_of_power.up)
 if buffpresent(stormkeeper_buff) and enemies(tagged=1) < 6 and azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 36 and { buffpresent(master_of_the_elements_buff) and not hastalent(surge_of_power_talent) or buffpresent(surge_of_power_buff) } spell(lightning_bolt_elemental)
 #earth_shock,if=!buff.surge_of_power.up&talent.master_of_the_elements.enabled&(buff.master_of_the_elements.up|cooldown.lava_burst.remains>0&maelstrom>=92+30*talent.call_the_thunder.enabled|(azerite.lava_shock.rank*buff.lava_shock.stack<36)&buff.stormkeeper.up&cooldown.lava_burst.remains<=gcd)
 if not buffpresent(surge_of_power_buff) and hastalent(master_of_the_elements_talent) and { buffpresent(master_of_the_elements_buff) or spellcooldown(lava_burst) > 0 and maelstrom() >= 92 + 30 * talentpoints(call_the_thunder_talent) or azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 36 and buffpresent(stormkeeper_buff) and spellcooldown(lava_burst) <= gcd() } spell(earth_shock)
 #earth_shock,if=!talent.master_of_the_elements.enabled&!(azerite.igneous_potential.rank>2&buff.ascendance.up)&(buff.stormkeeper.up|maelstrom>=90+30*talent.call_the_thunder.enabled|!(cooldown.storm_elemental.remains>(cooldown.storm_elemental.duration-30)&talent.storm_elemental.enabled)&expected_combat_length-time-cooldown.storm_elemental.remains-cooldown.storm_elemental.duration*floor((expected_combat_length-time-cooldown.storm_elemental.remains)%cooldown.storm_elemental.duration)>=30*(1+(azerite.echo_of_the_elementals.rank>=2)))
 if not hastalent(master_of_the_elements_talent) and not { azeritetraitrank(igneous_potential_trait) > 2 and buffpresent(ascendance_elemental_buff) } and { buffpresent(stormkeeper_buff) or maelstrom() >= 90 + 30 * talentpoints(call_the_thunder_talent) or not { spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) } and 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } >= 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } } spell(earth_shock)
 #earth_shock,if=talent.surge_of_power.enabled&!buff.surge_of_power.up&cooldown.lava_burst.remains<=gcd&(!talent.storm_elemental.enabled&!(cooldown.fire_elemental.remains>(cooldown.storm_elemental.duration-30))|talent.storm_elemental.enabled&!(cooldown.storm_elemental.remains>(cooldown.storm_elemental.duration-30)))
 if hastalent(surge_of_power_talent) and not buffpresent(surge_of_power_buff) and spellcooldown(lava_burst) <= gcd() and { not hastalent(storm_elemental_talent) and not spellcooldown(fire_elemental) > spellcooldownduration(storm_elemental) - 30 or hastalent(storm_elemental_talent) and not spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 } spell(earth_shock)
 #lightning_bolt,if=cooldown.storm_elemental.remains>(cooldown.storm_elemental.duration-30)&talent.storm_elemental.enabled&(azerite.igneous_potential.rank<2|!buff.lava_surge.up&buff.bloodlust.up)
 if spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) and { azeritetraitrank(igneous_potential_trait) < 2 or not buffpresent(lava_surge_buff) and buffpresent(burst_haste_buff_buff) } spell(lightning_bolt_elemental)
 #lightning_bolt,if=(buff.stormkeeper.remains<1.1*gcd*buff.stormkeeper.stack|buff.stormkeeper.up&buff.master_of_the_elements.up)
 if buffremaining(stormkeeper_buff) < 1.1 * gcd() * buffstacks(stormkeeper_buff) or buffpresent(stormkeeper_buff) and buffpresent(master_of_the_elements_buff) spell(lightning_bolt_elemental)
 #frost_shock,if=talent.icefury.enabled&talent.master_of_the_elements.enabled&buff.icefury.up&buff.master_of_the_elements.up
 if hastalent(icefury_talent) and hastalent(master_of_the_elements_talent) and buffpresent(icefury_buff) and buffpresent(master_of_the_elements_buff) spell(frost_shock)
 #lava_burst,if=buff.ascendance.up
 if buffpresent(ascendance_elemental_buff) spell(lava_burst)
 #flame_shock,target_if=refreshable&active_enemies>1&buff.surge_of_power.up
 if target.refreshable(flame_shock_debuff) and enemies(tagged=1) > 1 and buffpresent(surge_of_power_buff) spell(flame_shock)
 #lava_burst,if=talent.storm_elemental.enabled&cooldown_react&buff.surge_of_power.up&(expected_combat_length-time-cooldown.storm_elemental.remains-(cooldown.storm_elemental.duration-30)*floor((expected_combat_length-time-cooldown.storm_elemental.remains)%(cooldown.storm_elemental.duration-30))<30*(1+(azerite.echo_of_the_elementals.rank>=2))|(1.16*(expected_combat_length-time)-cooldown.storm_elemental.remains-cooldown.storm_elemental.duration*floor((1.16*(expected_combat_length-time)-cooldown.storm_elemental.remains)%cooldown.storm_elemental.duration))<(expected_combat_length-time-cooldown.storm_elemental.remains-cooldown.storm_elemental.duration*floor((expected_combat_length-time-cooldown.storm_elemental.remains)%cooldown.storm_elemental.duration)))
 if hastalent(storm_elemental_talent) and not spellcooldown(lava_burst) > 0 and buffpresent(surge_of_power_buff) and { 600 - timeincombat() - spellcooldown(storm_elemental) - { spellcooldownduration(storm_elemental) - 30 } * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / { spellcooldownduration(storm_elemental) - 30 } } < 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } or 1.16 * { 600 - timeincombat() } - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 1.16 * { 600 - timeincombat() } - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } < 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } } spell(lava_burst)
 #lava_burst,if=!talent.storm_elemental.enabled&cooldown_react&buff.surge_of_power.up&(expected_combat_length-time-cooldown.fire_elemental.remains-cooldown.fire_elemental.duration*floor((expected_combat_length-time-cooldown.fire_elemental.remains)%cooldown.fire_elemental.duration)<30*(1+(azerite.echo_of_the_elementals.rank>=2))|(1.16*(expected_combat_length-time)-cooldown.fire_elemental.remains-cooldown.fire_elemental.duration*floor((1.16*(expected_combat_length-time)-cooldown.fire_elemental.remains)%cooldown.fire_elemental.duration))<(expected_combat_length-time-cooldown.fire_elemental.remains-cooldown.fire_elemental.duration*floor((expected_combat_length-time-cooldown.fire_elemental.remains)%cooldown.fire_elemental.duration)))
 if not hastalent(storm_elemental_talent) and not spellcooldown(lava_burst) > 0 and buffpresent(surge_of_power_buff) and { 600 - timeincombat() - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 600 - timeincombat() - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } < 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } or 1.16 * { 600 - timeincombat() } - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 1.16 * { 600 - timeincombat() } - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } < 600 - timeincombat() - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 600 - timeincombat() - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } } spell(lava_burst)
 #lightning_bolt,if=buff.surge_of_power.up
 if buffpresent(surge_of_power_buff) spell(lightning_bolt_elemental)
 #lava_burst,if=cooldown_react&!talent.master_of_the_elements.enabled
 if not spellcooldown(lava_burst) > 0 and not hastalent(master_of_the_elements_talent) spell(lava_burst)
 #lava_burst,if=cooldown_react&charges>talent.echo_of_the_elements.enabled
 if not spellcooldown(lava_burst) > 0 and charges(lava_burst) > talentpoints(echo_of_the_elements_talent_elemental) spell(lava_burst)
 #frost_shock,if=talent.icefury.enabled&buff.icefury.up&buff.icefury.remains<1.1*gcd*buff.icefury.stack
 if hastalent(icefury_talent) and buffpresent(icefury_buff) and buffremaining(icefury_buff) < 1.1 * gcd() * buffstacks(icefury_buff) spell(frost_shock)
 #lava_burst,if=cooldown_react
 if not spellcooldown(lava_burst) > 0 spell(lava_burst)
 #concentrated_flame
 spell(concentrated_flame_essence)
 #flame_shock,target_if=refreshable&!buff.surge_of_power.up
 if target.refreshable(flame_shock_debuff) and not buffpresent(surge_of_power_buff) spell(flame_shock)
 #totem_mastery,if=talent.totem_mastery.enabled&(buff.resonance_totem.remains<6|(buff.resonance_totem.remains<(buff.ascendance.duration+cooldown.ascendance.remains)&cooldown.ascendance.remains<15))
 if hastalent(totem_mastery_talent_elemental) and { totemremaining(totem_mastery_elemental) < 6 or totemremaining(totem_mastery_elemental) < baseduration(ascendance_elemental_buff) + spellcooldown(ascendance_elemental) and spellcooldown(ascendance_elemental) < 15 } spell(totem_mastery_elemental)
 #frost_shock,if=talent.icefury.enabled&buff.icefury.up&(buff.icefury.remains<gcd*4*buff.icefury.stack|buff.stormkeeper.up|!talent.master_of_the_elements.enabled)
 if hastalent(icefury_talent) and buffpresent(icefury_buff) and { buffremaining(icefury_buff) < gcd() * 4 * buffstacks(icefury_buff) or buffpresent(stormkeeper_buff) or not hastalent(master_of_the_elements_talent) } spell(frost_shock)
 #lightning_bolt
 spell(lightning_bolt_elemental)
 #flame_shock,moving=1,target_if=refreshable
 if speed() > 0 and target.refreshable(flame_shock_debuff) spell(flame_shock)
 #flame_shock,moving=1,if=movement.distance>6
 if speed() > 0 and target.distance() > 6 spell(flame_shock)
 #frost_shock,moving=1
 if speed() > 0 spell(frost_shock)
}

AddFunction elementalfunnelmainpostconditions
{
}

AddFunction elementalfunnelshortcdactions
{
 unless { not target.debuffpresent(flame_shock_debuff) or target.debuffremaining(flame_shock_debuff) <= gcd() or hastalent(ascendance_talent) and target.debuffremaining(flame_shock_debuff) < spellcooldown(ascendance_elemental) + baseduration(ascendance_elemental_buff) and spellcooldown(ascendance_elemental) < 4 and { not hastalent(storm_elemental_talent) or hastalent(storm_elemental_talent) and spellcooldown(storm_elemental) < 120 } } and { buffstacks(wind_gust_buff) < 14 or azeritetraitrank(igneous_potential_trait) >= 2 or buffpresent(lava_surge_buff) or not buffpresent(burst_haste_buff_buff) } and not buffpresent(surge_of_power_buff) and spell(flame_shock)
 {
  #blood_of_the_enemy,if=!talent.ascendance.enabled&(!talent.storm_elemental.enabled|!talent.primal_elementalist.enabled)|talent.ascendance.enabled&(time>=60|buff.bloodlust.up)&cooldown.lava_burst.remains>0&(cooldown.storm_elemental.remains<(cooldown.storm_elemental.duration-30)|!talent.storm_elemental.enabled)&(!talent.icefury.enabled|!buff.icefury.up&!cooldown.icefury.up)
  if not hastalent(ascendance_talent) and { not hastalent(storm_elemental_talent) or not hastalent(primal_elementalist_talent) } or hastalent(ascendance_talent) and { timeincombat() >= 60 or buffpresent(burst_haste_buff_buff) } and spellcooldown(lava_burst) > 0 and { spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 or not hastalent(storm_elemental_talent) } and { not hastalent(icefury_talent) or not buffpresent(icefury_buff) and not { not spellcooldown(icefury) > 0 } } spell(blood_of_the_enemy)

  unless hastalent(elemental_blast_talent) and { hastalent(master_of_the_elements_talent) and buffpresent(master_of_the_elements_buff) and maelstrom() < 60 or not hastalent(master_of_the_elements_talent) } and { not { spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) } or azeritetraitrank(natural_harmony_trait) == 3 and buffstacks(wind_gust_buff) < 14 } and spell(elemental_blast)
  {
   #stormkeeper,if=talent.stormkeeper.enabled&(raid_event.adds.count<3|raid_event.adds.in>50)&(!talent.surge_of_power.enabled|buff.surge_of_power.up|maelstrom>=44)
   if hastalent(stormkeeper_talent) and { 0 < 3 or 600 > 50 } and { not hastalent(surge_of_power_talent) or buffpresent(surge_of_power_buff) or maelstrom() >= 44 } spell(stormkeeper)
   #liquid_magma_totem,if=talent.liquid_magma_totem.enabled&(raid_event.adds.count<3|raid_event.adds.in>50)
   if hastalent(liquid_magma_totem_talent) and { 0 < 3 or 600 > 50 } spell(liquid_magma_totem)

   unless buffpresent(stormkeeper_buff) and enemies(tagged=1) < 6 and azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 36 and { buffpresent(master_of_the_elements_buff) and not hastalent(surge_of_power_talent) or buffpresent(surge_of_power_buff) } and spell(lightning_bolt_elemental) or not buffpresent(surge_of_power_buff) and hastalent(master_of_the_elements_talent) and { buffpresent(master_of_the_elements_buff) or spellcooldown(lava_burst) > 0 and maelstrom() >= 92 + 30 * talentpoints(call_the_thunder_talent) or azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 36 and buffpresent(stormkeeper_buff) and spellcooldown(lava_burst) <= gcd() } and spell(earth_shock) or not hastalent(master_of_the_elements_talent) and not { azeritetraitrank(igneous_potential_trait) > 2 and buffpresent(ascendance_elemental_buff) } and { buffpresent(stormkeeper_buff) or maelstrom() >= 90 + 30 * talentpoints(call_the_thunder_talent) or not { spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) } and 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } >= 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } } and spell(earth_shock) or hastalent(surge_of_power_talent) and not buffpresent(surge_of_power_buff) and spellcooldown(lava_burst) <= gcd() and { not hastalent(storm_elemental_talent) and not spellcooldown(fire_elemental) > spellcooldownduration(storm_elemental) - 30 or hastalent(storm_elemental_talent) and not spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 } and spell(earth_shock) or spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) and { azeritetraitrank(igneous_potential_trait) < 2 or not buffpresent(lava_surge_buff) and buffpresent(burst_haste_buff_buff) } and spell(lightning_bolt_elemental) or { buffremaining(stormkeeper_buff) < 1.1 * gcd() * buffstacks(stormkeeper_buff) or buffpresent(stormkeeper_buff) and buffpresent(master_of_the_elements_buff) } and spell(lightning_bolt_elemental) or hastalent(icefury_talent) and hastalent(master_of_the_elements_talent) and buffpresent(icefury_buff) and buffpresent(master_of_the_elements_buff) and spell(frost_shock) or buffpresent(ascendance_elemental_buff) and spell(lava_burst) or target.refreshable(flame_shock_debuff) and enemies(tagged=1) > 1 and buffpresent(surge_of_power_buff) and spell(flame_shock) or hastalent(storm_elemental_talent) and not spellcooldown(lava_burst) > 0 and buffpresent(surge_of_power_buff) and { 600 - timeincombat() - spellcooldown(storm_elemental) - { spellcooldownduration(storm_elemental) - 30 } * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / { spellcooldownduration(storm_elemental) - 30 } } < 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } or 1.16 * { 600 - timeincombat() } - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 1.16 * { 600 - timeincombat() } - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } < 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } } and spell(lava_burst) or not hastalent(storm_elemental_talent) and not spellcooldown(lava_burst) > 0 and buffpresent(surge_of_power_buff) and { 600 - timeincombat() - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 600 - timeincombat() - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } < 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } or 1.16 * { 600 - timeincombat() } - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 1.16 * { 600 - timeincombat() } - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } < 600 - timeincombat() - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 600 - timeincombat() - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } } and spell(lava_burst) or buffpresent(surge_of_power_buff) and spell(lightning_bolt_elemental) or not spellcooldown(lava_burst) > 0 and not hastalent(master_of_the_elements_talent) and spell(lava_burst)
   {
    #icefury,if=talent.icefury.enabled&!(maelstrom>75&cooldown.lava_burst.remains<=0)&(!talent.storm_elemental.enabled|cooldown.storm_elemental.remains<cooldown.storm_elemental.duration)
    if hastalent(icefury_talent) and not { maelstrom() > 75 and spellcooldown(lava_burst) <= 0 } and { not hastalent(storm_elemental_talent) or spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) } spell(icefury)

    unless not spellcooldown(lava_burst) > 0 and charges(lava_burst) > talentpoints(echo_of_the_elements_talent_elemental) and spell(lava_burst) or hastalent(icefury_talent) and buffpresent(icefury_buff) and buffremaining(icefury_buff) < 1.1 * gcd() * buffstacks(icefury_buff) and spell(frost_shock) or not spellcooldown(lava_burst) > 0 and spell(lava_burst) or spell(concentrated_flame_essence)
    {
     #reaping_flames
     spell(reaping_flames_essence)
    }
   }
  }
 }
}

AddFunction elementalfunnelshortcdpostconditions
{
 { not target.debuffpresent(flame_shock_debuff) or target.debuffremaining(flame_shock_debuff) <= gcd() or hastalent(ascendance_talent) and target.debuffremaining(flame_shock_debuff) < spellcooldown(ascendance_elemental) + baseduration(ascendance_elemental_buff) and spellcooldown(ascendance_elemental) < 4 and { not hastalent(storm_elemental_talent) or hastalent(storm_elemental_talent) and spellcooldown(storm_elemental) < 120 } } and { buffstacks(wind_gust_buff) < 14 or azeritetraitrank(igneous_potential_trait) >= 2 or buffpresent(lava_surge_buff) or not buffpresent(burst_haste_buff_buff) } and not buffpresent(surge_of_power_buff) and spell(flame_shock) or hastalent(elemental_blast_talent) and { hastalent(master_of_the_elements_talent) and buffpresent(master_of_the_elements_buff) and maelstrom() < 60 or not hastalent(master_of_the_elements_talent) } and { not { spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) } or azeritetraitrank(natural_harmony_trait) == 3 and buffstacks(wind_gust_buff) < 14 } and spell(elemental_blast) or buffpresent(stormkeeper_buff) and enemies(tagged=1) < 6 and azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 36 and { buffpresent(master_of_the_elements_buff) and not hastalent(surge_of_power_talent) or buffpresent(surge_of_power_buff) } and spell(lightning_bolt_elemental) or not buffpresent(surge_of_power_buff) and hastalent(master_of_the_elements_talent) and { buffpresent(master_of_the_elements_buff) or spellcooldown(lava_burst) > 0 and maelstrom() >= 92 + 30 * talentpoints(call_the_thunder_talent) or azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 36 and buffpresent(stormkeeper_buff) and spellcooldown(lava_burst) <= gcd() } and spell(earth_shock) or not hastalent(master_of_the_elements_talent) and not { azeritetraitrank(igneous_potential_trait) > 2 and buffpresent(ascendance_elemental_buff) } and { buffpresent(stormkeeper_buff) or maelstrom() >= 90 + 30 * talentpoints(call_the_thunder_talent) or not { spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) } and 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } >= 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } } and spell(earth_shock) or hastalent(surge_of_power_talent) and not buffpresent(surge_of_power_buff) and spellcooldown(lava_burst) <= gcd() and { not hastalent(storm_elemental_talent) and not spellcooldown(fire_elemental) > spellcooldownduration(storm_elemental) - 30 or hastalent(storm_elemental_talent) and not spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 } and spell(earth_shock) or spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) and { azeritetraitrank(igneous_potential_trait) < 2 or not buffpresent(lava_surge_buff) and buffpresent(burst_haste_buff_buff) } and spell(lightning_bolt_elemental) or { buffremaining(stormkeeper_buff) < 1.1 * gcd() * buffstacks(stormkeeper_buff) or buffpresent(stormkeeper_buff) and buffpresent(master_of_the_elements_buff) } and spell(lightning_bolt_elemental) or hastalent(icefury_talent) and hastalent(master_of_the_elements_talent) and buffpresent(icefury_buff) and buffpresent(master_of_the_elements_buff) and spell(frost_shock) or buffpresent(ascendance_elemental_buff) and spell(lava_burst) or target.refreshable(flame_shock_debuff) and enemies(tagged=1) > 1 and buffpresent(surge_of_power_buff) and spell(flame_shock) or hastalent(storm_elemental_talent) and not spellcooldown(lava_burst) > 0 and buffpresent(surge_of_power_buff) and { 600 - timeincombat() - spellcooldown(storm_elemental) - { spellcooldownduration(storm_elemental) - 30 } * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / { spellcooldownduration(storm_elemental) - 30 } } < 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } or 1.16 * { 600 - timeincombat() } - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 1.16 * { 600 - timeincombat() } - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } < 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } } and spell(lava_burst) or not hastalent(storm_elemental_talent) and not spellcooldown(lava_burst) > 0 and buffpresent(surge_of_power_buff) and { 600 - timeincombat() - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 600 - timeincombat() - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } < 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } or 1.16 * { 600 - timeincombat() } - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 1.16 * { 600 - timeincombat() } - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } < 600 - timeincombat() - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 600 - timeincombat() - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } } and spell(lava_burst) or buffpresent(surge_of_power_buff) and spell(lightning_bolt_elemental) or not spellcooldown(lava_burst) > 0 and not hastalent(master_of_the_elements_talent) and spell(lava_burst) or not spellcooldown(lava_burst) > 0 and charges(lava_burst) > talentpoints(echo_of_the_elements_talent_elemental) and spell(lava_burst) or hastalent(icefury_talent) and buffpresent(icefury_buff) and buffremaining(icefury_buff) < 1.1 * gcd() * buffstacks(icefury_buff) and spell(frost_shock) or not spellcooldown(lava_burst) > 0 and spell(lava_burst) or spell(concentrated_flame_essence) or target.refreshable(flame_shock_debuff) and not buffpresent(surge_of_power_buff) and spell(flame_shock) or hastalent(totem_mastery_talent_elemental) and { totemremaining(totem_mastery_elemental) < 6 or totemremaining(totem_mastery_elemental) < baseduration(ascendance_elemental_buff) + spellcooldown(ascendance_elemental) and spellcooldown(ascendance_elemental) < 15 } and spell(totem_mastery_elemental) or hastalent(icefury_talent) and buffpresent(icefury_buff) and { buffremaining(icefury_buff) < gcd() * 4 * buffstacks(icefury_buff) or buffpresent(stormkeeper_buff) or not hastalent(master_of_the_elements_talent) } and spell(frost_shock) or spell(lightning_bolt_elemental) or speed() > 0 and target.refreshable(flame_shock_debuff) and spell(flame_shock) or speed() > 0 and target.distance() > 6 and spell(flame_shock) or speed() > 0 and spell(frost_shock)
}

AddFunction elementalfunnelcdactions
{
 unless { not target.debuffpresent(flame_shock_debuff) or target.debuffremaining(flame_shock_debuff) <= gcd() or hastalent(ascendance_talent) and target.debuffremaining(flame_shock_debuff) < spellcooldown(ascendance_elemental) + baseduration(ascendance_elemental_buff) and spellcooldown(ascendance_elemental) < 4 and { not hastalent(storm_elemental_talent) or hastalent(storm_elemental_talent) and spellcooldown(storm_elemental) < 120 } } and { buffstacks(wind_gust_buff) < 14 or azeritetraitrank(igneous_potential_trait) >= 2 or buffpresent(lava_surge_buff) or not buffpresent(burst_haste_buff_buff) } and not buffpresent(surge_of_power_buff) and spell(flame_shock)
 {
  #ascendance,if=talent.ascendance.enabled&(time>=60|buff.bloodlust.up)&cooldown.lava_burst.remains>0&(cooldown.storm_elemental.remains<(cooldown.storm_elemental.duration-30)|!talent.storm_elemental.enabled)&(!talent.icefury.enabled|!buff.icefury.up&!cooldown.icefury.up)
  if hastalent(ascendance_talent) and { timeincombat() >= 60 or buffpresent(burst_haste_buff_buff) } and spellcooldown(lava_burst) > 0 and { spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 or not hastalent(storm_elemental_talent) } and { not hastalent(icefury_talent) or not buffpresent(icefury_buff) and not { not spellcooldown(icefury) > 0 } } and buffexpires(ascendance_elemental_buff) spell(ascendance_elemental)

  unless hastalent(elemental_blast_talent) and { hastalent(master_of_the_elements_talent) and buffpresent(master_of_the_elements_buff) and maelstrom() < 60 or not hastalent(master_of_the_elements_talent) } and { not { spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) } or azeritetraitrank(natural_harmony_trait) == 3 and buffstacks(wind_gust_buff) < 14 } and spell(elemental_blast) or hastalent(stormkeeper_talent) and { 0 < 3 or 600 > 50 } and { not hastalent(surge_of_power_talent) or buffpresent(surge_of_power_buff) or maelstrom() >= 44 } and spell(stormkeeper) or hastalent(liquid_magma_totem_talent) and { 0 < 3 or 600 > 50 } and spell(liquid_magma_totem) or buffpresent(stormkeeper_buff) and enemies(tagged=1) < 6 and azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 36 and { buffpresent(master_of_the_elements_buff) and not hastalent(surge_of_power_talent) or buffpresent(surge_of_power_buff) } and spell(lightning_bolt_elemental) or not buffpresent(surge_of_power_buff) and hastalent(master_of_the_elements_talent) and { buffpresent(master_of_the_elements_buff) or spellcooldown(lava_burst) > 0 and maelstrom() >= 92 + 30 * talentpoints(call_the_thunder_talent) or azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 36 and buffpresent(stormkeeper_buff) and spellcooldown(lava_burst) <= gcd() } and spell(earth_shock) or not hastalent(master_of_the_elements_talent) and not { azeritetraitrank(igneous_potential_trait) > 2 and buffpresent(ascendance_elemental_buff) } and { buffpresent(stormkeeper_buff) or maelstrom() >= 90 + 30 * talentpoints(call_the_thunder_talent) or not { spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) } and 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } >= 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } } and spell(earth_shock) or hastalent(surge_of_power_talent) and not buffpresent(surge_of_power_buff) and spellcooldown(lava_burst) <= gcd() and { not hastalent(storm_elemental_talent) and not spellcooldown(fire_elemental) > spellcooldownduration(storm_elemental) - 30 or hastalent(storm_elemental_talent) and not spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 } and spell(earth_shock) or spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) and { azeritetraitrank(igneous_potential_trait) < 2 or not buffpresent(lava_surge_buff) and buffpresent(burst_haste_buff_buff) } and spell(lightning_bolt_elemental) or { buffremaining(stormkeeper_buff) < 1.1 * gcd() * buffstacks(stormkeeper_buff) or buffpresent(stormkeeper_buff) and buffpresent(master_of_the_elements_buff) } and spell(lightning_bolt_elemental) or hastalent(icefury_talent) and hastalent(master_of_the_elements_talent) and buffpresent(icefury_buff) and buffpresent(master_of_the_elements_buff) and spell(frost_shock) or buffpresent(ascendance_elemental_buff) and spell(lava_burst) or target.refreshable(flame_shock_debuff) and enemies(tagged=1) > 1 and buffpresent(surge_of_power_buff) and spell(flame_shock) or hastalent(storm_elemental_talent) and not spellcooldown(lava_burst) > 0 and buffpresent(surge_of_power_buff) and { 600 - timeincombat() - spellcooldown(storm_elemental) - { spellcooldownduration(storm_elemental) - 30 } * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / { spellcooldownduration(storm_elemental) - 30 } } < 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } or 1.16 * { 600 - timeincombat() } - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 1.16 * { 600 - timeincombat() } - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } < 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } } and spell(lava_burst) or not hastalent(storm_elemental_talent) and not spellcooldown(lava_burst) > 0 and buffpresent(surge_of_power_buff) and { 600 - timeincombat() - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 600 - timeincombat() - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } < 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } or 1.16 * { 600 - timeincombat() } - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 1.16 * { 600 - timeincombat() } - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } < 600 - timeincombat() - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 600 - timeincombat() - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } } and spell(lava_burst) or buffpresent(surge_of_power_buff) and spell(lightning_bolt_elemental) or not spellcooldown(lava_burst) > 0 and not hastalent(master_of_the_elements_talent) and spell(lava_burst) or hastalent(icefury_talent) and not { maelstrom() > 75 and spellcooldown(lava_burst) <= 0 } and { not hastalent(storm_elemental_talent) or spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) } and spell(icefury) or not spellcooldown(lava_burst) > 0 and charges(lava_burst) > talentpoints(echo_of_the_elements_talent_elemental) and spell(lava_burst) or hastalent(icefury_talent) and buffpresent(icefury_buff) and buffremaining(icefury_buff) < 1.1 * gcd() * buffstacks(icefury_buff) and spell(frost_shock) or not spellcooldown(lava_burst) > 0 and spell(lava_burst) or spell(concentrated_flame_essence) or spell(reaping_flames_essence) or target.refreshable(flame_shock_debuff) and not buffpresent(surge_of_power_buff) and spell(flame_shock) or hastalent(totem_mastery_talent_elemental) and { totemremaining(totem_mastery_elemental) < 6 or totemremaining(totem_mastery_elemental) < baseduration(ascendance_elemental_buff) + spellcooldown(ascendance_elemental) and spellcooldown(ascendance_elemental) < 15 } and spell(totem_mastery_elemental) or hastalent(icefury_talent) and buffpresent(icefury_buff) and { buffremaining(icefury_buff) < gcd() * 4 * buffstacks(icefury_buff) or buffpresent(stormkeeper_buff) or not hastalent(master_of_the_elements_talent) } and spell(frost_shock)
  {
   #earth_elemental,if=!talent.primal_elementalist.enabled|talent.primal_elementalist.enabled&(cooldown.fire_elemental.remains<(cooldown.fire_elemental.duration-30)&!talent.storm_elemental.enabled|cooldown.storm_elemental.remains<(cooldown.storm_elemental.duration-30)&talent.storm_elemental.enabled)
   if not hastalent(primal_elementalist_talent) or hastalent(primal_elementalist_talent) and { spellcooldown(fire_elemental) < spellcooldownduration(fire_elemental) - 30 and not hastalent(storm_elemental_talent) or spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) } spell(earth_elemental)
  }
 }
}

AddFunction elementalfunnelcdpostconditions
{
 { not target.debuffpresent(flame_shock_debuff) or target.debuffremaining(flame_shock_debuff) <= gcd() or hastalent(ascendance_talent) and target.debuffremaining(flame_shock_debuff) < spellcooldown(ascendance_elemental) + baseduration(ascendance_elemental_buff) and spellcooldown(ascendance_elemental) < 4 and { not hastalent(storm_elemental_talent) or hastalent(storm_elemental_talent) and spellcooldown(storm_elemental) < 120 } } and { buffstacks(wind_gust_buff) < 14 or azeritetraitrank(igneous_potential_trait) >= 2 or buffpresent(lava_surge_buff) or not buffpresent(burst_haste_buff_buff) } and not buffpresent(surge_of_power_buff) and spell(flame_shock) or hastalent(elemental_blast_talent) and { hastalent(master_of_the_elements_talent) and buffpresent(master_of_the_elements_buff) and maelstrom() < 60 or not hastalent(master_of_the_elements_talent) } and { not { spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) } or azeritetraitrank(natural_harmony_trait) == 3 and buffstacks(wind_gust_buff) < 14 } and spell(elemental_blast) or hastalent(stormkeeper_talent) and { 0 < 3 or 600 > 50 } and { not hastalent(surge_of_power_talent) or buffpresent(surge_of_power_buff) or maelstrom() >= 44 } and spell(stormkeeper) or hastalent(liquid_magma_totem_talent) and { 0 < 3 or 600 > 50 } and spell(liquid_magma_totem) or buffpresent(stormkeeper_buff) and enemies(tagged=1) < 6 and azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 36 and { buffpresent(master_of_the_elements_buff) and not hastalent(surge_of_power_talent) or buffpresent(surge_of_power_buff) } and spell(lightning_bolt_elemental) or not buffpresent(surge_of_power_buff) and hastalent(master_of_the_elements_talent) and { buffpresent(master_of_the_elements_buff) or spellcooldown(lava_burst) > 0 and maelstrom() >= 92 + 30 * talentpoints(call_the_thunder_talent) or azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 36 and buffpresent(stormkeeper_buff) and spellcooldown(lava_burst) <= gcd() } and spell(earth_shock) or not hastalent(master_of_the_elements_talent) and not { azeritetraitrank(igneous_potential_trait) > 2 and buffpresent(ascendance_elemental_buff) } and { buffpresent(stormkeeper_buff) or maelstrom() >= 90 + 30 * talentpoints(call_the_thunder_talent) or not { spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) } and 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } >= 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } } and spell(earth_shock) or hastalent(surge_of_power_talent) and not buffpresent(surge_of_power_buff) and spellcooldown(lava_burst) <= gcd() and { not hastalent(storm_elemental_talent) and not spellcooldown(fire_elemental) > spellcooldownduration(storm_elemental) - 30 or hastalent(storm_elemental_talent) and not spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 } and spell(earth_shock) or spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) and { azeritetraitrank(igneous_potential_trait) < 2 or not buffpresent(lava_surge_buff) and buffpresent(burst_haste_buff_buff) } and spell(lightning_bolt_elemental) or { buffremaining(stormkeeper_buff) < 1.1 * gcd() * buffstacks(stormkeeper_buff) or buffpresent(stormkeeper_buff) and buffpresent(master_of_the_elements_buff) } and spell(lightning_bolt_elemental) or hastalent(icefury_talent) and hastalent(master_of_the_elements_talent) and buffpresent(icefury_buff) and buffpresent(master_of_the_elements_buff) and spell(frost_shock) or buffpresent(ascendance_elemental_buff) and spell(lava_burst) or target.refreshable(flame_shock_debuff) and enemies(tagged=1) > 1 and buffpresent(surge_of_power_buff) and spell(flame_shock) or hastalent(storm_elemental_talent) and not spellcooldown(lava_burst) > 0 and buffpresent(surge_of_power_buff) and { 600 - timeincombat() - spellcooldown(storm_elemental) - { spellcooldownduration(storm_elemental) - 30 } * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / { spellcooldownduration(storm_elemental) - 30 } } < 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } or 1.16 * { 600 - timeincombat() } - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 1.16 * { 600 - timeincombat() } - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } < 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } } and spell(lava_burst) or not hastalent(storm_elemental_talent) and not spellcooldown(lava_burst) > 0 and buffpresent(surge_of_power_buff) and { 600 - timeincombat() - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 600 - timeincombat() - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } < 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } or 1.16 * { 600 - timeincombat() } - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 1.16 * { 600 - timeincombat() } - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } < 600 - timeincombat() - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 600 - timeincombat() - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } } and spell(lava_burst) or buffpresent(surge_of_power_buff) and spell(lightning_bolt_elemental) or not spellcooldown(lava_burst) > 0 and not hastalent(master_of_the_elements_talent) and spell(lava_burst) or hastalent(icefury_talent) and not { maelstrom() > 75 and spellcooldown(lava_burst) <= 0 } and { not hastalent(storm_elemental_talent) or spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) } and spell(icefury) or not spellcooldown(lava_burst) > 0 and charges(lava_burst) > talentpoints(echo_of_the_elements_talent_elemental) and spell(lava_burst) or hastalent(icefury_talent) and buffpresent(icefury_buff) and buffremaining(icefury_buff) < 1.1 * gcd() * buffstacks(icefury_buff) and spell(frost_shock) or not spellcooldown(lava_burst) > 0 and spell(lava_burst) or spell(concentrated_flame_essence) or spell(reaping_flames_essence) or target.refreshable(flame_shock_debuff) and not buffpresent(surge_of_power_buff) and spell(flame_shock) or hastalent(totem_mastery_talent_elemental) and { totemremaining(totem_mastery_elemental) < 6 or totemremaining(totem_mastery_elemental) < baseduration(ascendance_elemental_buff) + spellcooldown(ascendance_elemental) and spellcooldown(ascendance_elemental) < 15 } and spell(totem_mastery_elemental) or hastalent(icefury_talent) and buffpresent(icefury_buff) and { buffremaining(icefury_buff) < gcd() * 4 * buffstacks(icefury_buff) or buffpresent(stormkeeper_buff) or not hastalent(master_of_the_elements_talent) } and spell(frost_shock) or spell(lightning_bolt_elemental) or speed() > 0 and target.refreshable(flame_shock_debuff) and spell(flame_shock) or speed() > 0 and target.distance() > 6 and spell(flame_shock) or speed() > 0 and spell(frost_shock)
}

### actions.precombat

AddFunction elementalprecombatmainactions
{
 #flask
 #food
 #augmentation
 #snapshot_stats
 #totem_mastery
 spell(totem_mastery_elemental)
 #elemental_blast,if=talent.elemental_blast.enabled
 if hastalent(elemental_blast_talent) spell(elemental_blast)
 #lava_burst,if=!talent.elemental_blast.enabled
 if not hastalent(elemental_blast_talent) spell(lava_burst)
}

AddFunction elementalprecombatmainpostconditions
{
}

AddFunction elementalprecombatshortcdactions
{
 unless spell(totem_mastery_elemental)
 {
  #stormkeeper,if=talent.stormkeeper.enabled&(raid_event.adds.count<3|raid_event.adds.in>50)
  if hastalent(stormkeeper_talent) and { 0 < 3 or 600 > 50 } spell(stormkeeper)
 }
}

AddFunction elementalprecombatshortcdpostconditions
{
 spell(totem_mastery_elemental) or hastalent(elemental_blast_talent) and spell(elemental_blast) or not hastalent(elemental_blast_talent) and spell(lava_burst)
}

AddFunction elementalprecombatcdactions
{
 unless spell(totem_mastery_elemental)
 {
  #earth_elemental,if=!talent.primal_elementalist.enabled
  if not hastalent(primal_elementalist_talent) spell(earth_elemental)
  #use_item,name=azsharas_font_of_power
  elementaluseitemactions()

  unless hastalent(stormkeeper_talent) and { 0 < 3 or 600 > 50 } and spell(stormkeeper)
  {
   #potion
   # if checkboxon(opt_use_consumables) and target.classification(worldboss) item(unbridled_fury_item usable=1)
  }
 }
}

AddFunction elementalprecombatcdpostconditions
{
 spell(totem_mastery_elemental) or hastalent(stormkeeper_talent) and { 0 < 3 or 600 > 50 } and spell(stormkeeper) or hastalent(elemental_blast_talent) and spell(elemental_blast) or not hastalent(elemental_blast_talent) and spell(lava_burst)
}

### actions.single_target

AddFunction shamanmainactions
{
 #flame_shock,target_if=(!ticking|dot.flame_shock.remains<=gcd|talent.ascendance.enabled&dot.flame_shock.remains<(cooldown.ascendance.remains+buff.ascendance.duration)&cooldown.ascendance.remains<4&(!talent.storm_elemental.enabled|talent.storm_elemental.enabled&cooldown.storm_elemental.remains<120))&(buff.wind_gust.stack<14|azerite.igneous_potential.rank>=2|buff.lava_surge.up|!buff.bloodlust.up)&!buff.surge_of_power.up
 if { not target.debuffpresent(flame_shock_debuff) or target.debuffremaining(flame_shock_debuff) <= gcd() or hastalent(ascendance_talent) and target.debuffremaining(flame_shock_debuff) < spellcooldown(ascendance_elemental) + baseduration(ascendance_elemental_buff) and spellcooldown(ascendance_elemental) < 4 and { not hastalent(storm_elemental_talent) or hastalent(storm_elemental_talent) and spellcooldown(storm_elemental) < 120 } } and { buffstacks(wind_gust_buff) < 14 or azeritetraitrank(igneous_potential_trait) >= 2 or buffpresent(lava_surge_buff) or not buffpresent(burst_haste_buff_buff) } and not buffpresent(surge_of_power_buff) spell(flame_shock)
 #elemental_blast,if=talent.elemental_blast.enabled&(talent.master_of_the_elements.enabled&(buff.master_of_the_elements.up&maelstrom<60|!buff.master_of_the_elements.up)|!talent.master_of_the_elements.enabled)&(!(cooldown.storm_elemental.remains>(cooldown.storm_elemental.duration-30)&talent.storm_elemental.enabled)|azerite.natural_harmony.rank=3&buff.wind_gust.stack<14)
 if hastalent(elemental_blast_talent) and { hastalent(master_of_the_elements_talent) and { buffpresent(master_of_the_elements_buff) and maelstrom() < 60 or not buffpresent(master_of_the_elements_buff) } or not hastalent(master_of_the_elements_talent) } and { not { spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) } or azeritetraitrank(natural_harmony_trait) == 3 and buffstacks(wind_gust_buff) < 14 } spell(elemental_blast)
 #lightning_bolt,if=buff.stormkeeper.up&spell_targets.chain_lightning<2&(azerite.lava_shock.rank*buff.lava_shock.stack)<26&(buff.master_of_the_elements.up&!talent.surge_of_power.enabled|buff.surge_of_power.up)
 if buffpresent(stormkeeper_buff) and enemies(tagged=1) < 2 and azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 26 and { buffpresent(master_of_the_elements_buff) and not hastalent(surge_of_power_talent) or buffpresent(surge_of_power_buff) } spell(lightning_bolt_elemental)
 #earthquake,if=(spell_targets.chain_lightning>1|azerite.tectonic_thunder.rank>=3&!talent.surge_of_power.enabled&azerite.lava_shock.rank<1)&azerite.lava_shock.rank*buff.lava_shock.stack<(36+3*azerite.tectonic_thunder.rank*spell_targets.chain_lightning)&(!talent.surge_of_power.enabled|!dot.flame_shock.refreshable|cooldown.storm_elemental.remains>(cooldown.storm_elemental.duration-30))&(!talent.master_of_the_elements.enabled|buff.master_of_the_elements.up|cooldown.lava_burst.remains>0&maelstrom>=92+30*talent.call_the_thunder.enabled)
 if { enemies(tagged=1) > 1 or azeritetraitrank(tectonic_thunder_trait) >= 3 and not hastalent(surge_of_power_talent) and azeritetraitrank(lava_shock_trait) < 1 } and azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 36 + 3 * azeritetraitrank(tectonic_thunder_trait) * enemies(tagged=1) and { not hastalent(surge_of_power_talent) or not target.debuffrefreshable(flame_shock_debuff) or spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 } and { not hastalent(master_of_the_elements_talent) or buffpresent(master_of_the_elements_buff) or spellcooldown(lava_burst) > 0 and maelstrom() >= 92 + 30 * talentpoints(call_the_thunder_talent) } spell(earthquake)
 #earth_shock,if=!buff.surge_of_power.up&talent.master_of_the_elements.enabled&(buff.master_of_the_elements.up|cooldown.lava_burst.remains>0&maelstrom>=92+30*talent.call_the_thunder.enabled|spell_targets.chain_lightning<2&(azerite.lava_shock.rank*buff.lava_shock.stack<26)&buff.stormkeeper.up&cooldown.lava_burst.remains<=gcd)
 if not buffpresent(surge_of_power_buff) and hastalent(master_of_the_elements_talent) and { buffpresent(master_of_the_elements_buff) or spellcooldown(lava_burst) > 0 and maelstrom() >= 92 + 30 * talentpoints(call_the_thunder_talent) or enemies(tagged=1) < 2 and azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 26 and buffpresent(stormkeeper_buff) and spellcooldown(lava_burst) <= gcd() } spell(earth_shock)
 #earth_shock,if=!talent.master_of_the_elements.enabled&!(azerite.igneous_potential.rank>2&buff.ascendance.up)&(buff.stormkeeper.up|maelstrom>=90+30*talent.call_the_thunder.enabled|!(cooldown.storm_elemental.remains>cooldown.storm_elemental.duration&talent.storm_elemental.enabled)&expected_combat_length-time-cooldown.storm_elemental.remains-cooldown.storm_elemental.duration*floor((expected_combat_length-time-cooldown.storm_elemental.remains)%cooldown.storm_elemental.duration)>=30*(1+(azerite.echo_of_the_elementals.rank>=2)))
 if not hastalent(master_of_the_elements_talent) and not { azeritetraitrank(igneous_potential_trait) > 2 and buffpresent(ascendance_elemental_buff) } and { buffpresent(stormkeeper_buff) or maelstrom() >= 90 + 30 * talentpoints(call_the_thunder_talent) or not { spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) and hastalent(storm_elemental_talent) } and 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } >= 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } } spell(earth_shock)
 #earth_shock,if=talent.surge_of_power.enabled&!buff.surge_of_power.up&cooldown.lava_burst.remains<=gcd&(!talent.storm_elemental.enabled&!(cooldown.fire_elemental.remains>(cooldown.fire_elemental.duration-30))|talent.storm_elemental.enabled&!(cooldown.storm_elemental.remains>(cooldown.storm_elemental.duration-30)))
 if hastalent(surge_of_power_talent) and not buffpresent(surge_of_power_buff) and spellcooldown(lava_burst) <= gcd() and { not hastalent(storm_elemental_talent) and not spellcooldown(fire_elemental) > spellcooldownduration(fire_elemental) - 30 or hastalent(storm_elemental_talent) and not spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 } spell(earth_shock)
 #lightning_lasso
 spell(lightning_lasso)
 #lightning_bolt,if=cooldown.storm_elemental.remains>(cooldown.storm_elemental.duration-30)&talent.storm_elemental.enabled&(azerite.igneous_potential.rank<2|!buff.lava_surge.up&buff.bloodlust.up)
 if spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) and { azeritetraitrank(igneous_potential_trait) < 2 or not buffpresent(lava_surge_buff) and buffpresent(burst_haste_buff_buff) } spell(lightning_bolt_elemental)
 #lightning_bolt,if=(buff.stormkeeper.remains<1.1*gcd*buff.stormkeeper.stack|buff.stormkeeper.up&buff.master_of_the_elements.up)
 if buffremaining(stormkeeper_buff) < 1.1 * gcd() * buffstacks(stormkeeper_buff) or buffpresent(stormkeeper_buff) and buffpresent(master_of_the_elements_buff) spell(lightning_bolt_elemental)
 #frost_shock,if=talent.icefury.enabled&talent.master_of_the_elements.enabled&buff.icefury.up&buff.master_of_the_elements.up
 if hastalent(icefury_talent) and hastalent(master_of_the_elements_talent) and buffpresent(icefury_buff) and buffpresent(master_of_the_elements_buff) spell(frost_shock)
 #lava_burst,if=buff.ascendance.up
 if buffpresent(ascendance_elemental_buff) spell(lava_burst)
 #flame_shock,target_if=refreshable&active_enemies>1&buff.surge_of_power.up
 if target.refreshable(flame_shock_debuff) and enemies(tagged=1) > 1 and buffpresent(surge_of_power_buff) spell(flame_shock)
 #lava_burst,if=talent.storm_elemental.enabled&cooldown_react&buff.surge_of_power.up&(expected_combat_length-time-cooldown.storm_elemental.remains-cooldown.storm_elemental.duration*floor((expected_combat_length-time-cooldown.storm_elemental.remains)%cooldown.storm_elemental.duration)<30*(1+(azerite.echo_of_the_elementals.rank>=2))|(1.16*(expected_combat_length-time)-cooldown.storm_elemental.remains-cooldown.storm_elemental.duration*floor((1.16*(expected_combat_length-time)-cooldown.storm_elemental.remains)%cooldown.storm_elemental.duration))<(expected_combat_length-time-cooldown.storm_elemental.remains-cooldown.storm_elemental.duration*floor((expected_combat_length-time-cooldown.storm_elemental.remains)%cooldown.storm_elemental.duration)))
 if hastalent(storm_elemental_talent) and not spellcooldown(lava_burst) > 0 and buffpresent(surge_of_power_buff) and { 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } < 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } or 1.16 * { 600 - timeincombat() } - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 1.16 * { 600 - timeincombat() } - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } < 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } } spell(lava_burst)
 #lava_burst,if=!talent.storm_elemental.enabled&cooldown_react&buff.surge_of_power.up&(expected_combat_length-time-cooldown.fire_elemental.remains-cooldown.fire_elemental.duration*floor((expected_combat_length-time-cooldown.fire_elemental.remains)%cooldown.fire_elemental.duration)<30*(1+(azerite.echo_of_the_elementals.rank>=2))|(1.16*(expected_combat_length-time)-cooldown.fire_elemental.remains-cooldown.fire_elemental.duration*floor((1.16*(expected_combat_length-time)-cooldown.fire_elemental.remains)%cooldown.fire_elemental.duration))<(expected_combat_length-time-cooldown.fire_elemental.remains-cooldown.fire_elemental.duration*floor((expected_combat_length-time-cooldown.fire_elemental.remains)%cooldown.fire_elemental.duration)))
 if not hastalent(storm_elemental_talent) and not spellcooldown(lava_burst) > 0 and buffpresent(surge_of_power_buff) and { 600 - timeincombat() - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 600 - timeincombat() - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } < 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } or 1.16 * { 600 - timeincombat() } - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 1.16 * { 600 - timeincombat() } - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } < 600 - timeincombat() - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 600 - timeincombat() - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } } spell(lava_burst)
 #lightning_bolt,if=buff.surge_of_power.up
 if buffpresent(surge_of_power_buff) spell(lightning_bolt_elemental)
 #lava_burst,if=cooldown_react&!talent.master_of_the_elements.enabled
 if not spellcooldown(lava_burst) > 0 and not hastalent(master_of_the_elements_talent) spell(lava_burst)
 #lava_burst,if=cooldown_react&charges>talent.echo_of_the_elements.enabled
 if not spellcooldown(lava_burst) > 0 and charges(lava_burst) > talentpoints(echo_of_the_elements_talent_elemental) spell(lava_burst)
 #frost_shock,if=talent.icefury.enabled&buff.icefury.up&buff.icefury.remains<1.1*gcd*buff.icefury.stack
 if hastalent(icefury_talent) and buffpresent(icefury_buff) and buffremaining(icefury_buff) < 1.1 * gcd() * buffstacks(icefury_buff) spell(frost_shock)
 #lava_burst,if=cooldown_react
 if not spellcooldown(lava_burst) > 0 spell(lava_burst)
 #concentrated_flame
 spell(concentrated_flame_essence)
 #flame_shock,target_if=refreshable&!buff.surge_of_power.up
 if target.refreshable(flame_shock_debuff) and not buffpresent(surge_of_power_buff) spell(flame_shock)
 #totem_mastery,if=talent.totem_mastery.enabled&(buff.resonance_totem.remains<6|(buff.resonance_totem.remains<(buff.ascendance.duration+cooldown.ascendance.remains)&cooldown.ascendance.remains<15))
 if hastalent(totem_mastery_talent_elemental) and { totemremaining(totem_mastery_elemental) < 6 or totemremaining(totem_mastery_elemental) < baseduration(ascendance_elemental_buff) + spellcooldown(ascendance_elemental) and spellcooldown(ascendance_elemental) < 15 } spell(totem_mastery_elemental)
 #frost_shock,if=talent.icefury.enabled&buff.icefury.up&(buff.icefury.remains<gcd*4*buff.icefury.stack|buff.stormkeeper.up|!talent.master_of_the_elements.enabled)
 if hastalent(icefury_talent) and buffpresent(icefury_buff) and { buffremaining(icefury_buff) < gcd() * 4 * buffstacks(icefury_buff) or buffpresent(stormkeeper_buff) or not hastalent(master_of_the_elements_talent) } spell(frost_shock)
 #chain_lightning,if=buff.tectonic_thunder.up&!buff.stormkeeper.up&spell_targets.chain_lightning>1
 if buffpresent(tectonic_thunder) and not buffpresent(stormkeeper_buff) and enemies(tagged=1) > 1 spell(chain_lightning_elemental)
 #lightning_bolt
 spell(lightning_bolt_elemental)
 #flame_shock,moving=1,target_if=refreshable
 if speed() > 0 and target.refreshable(flame_shock_debuff) spell(flame_shock)
 #flame_shock,moving=1,if=movement.distance>6
 if speed() > 0 and target.distance() > 6 spell(flame_shock)
 #frost_shock,moving=1
 if speed() > 0 spell(frost_shock)
}

AddFunction shamanmainpostconditions
{
}

AddFunction shamanshortcdactions
{
 unless { not target.debuffpresent(flame_shock_debuff) or target.debuffremaining(flame_shock_debuff) <= gcd() or hastalent(ascendance_talent) and target.debuffremaining(flame_shock_debuff) < spellcooldown(ascendance_elemental) + baseduration(ascendance_elemental_buff) and spellcooldown(ascendance_elemental) < 4 and { not hastalent(storm_elemental_talent) or hastalent(storm_elemental_talent) and spellcooldown(storm_elemental) < 120 } } and { buffstacks(wind_gust_buff) < 14 or azeritetraitrank(igneous_potential_trait) >= 2 or buffpresent(lava_surge_buff) or not buffpresent(burst_haste_buff_buff) } and not buffpresent(surge_of_power_buff) and spell(flame_shock)
 {
  #blood_of_the_enemy,if=!talent.ascendance.enabled&!talent.storm_elemental.enabled|talent.ascendance.enabled&(time>=60|buff.bloodlust.up)&cooldown.lava_burst.remains>0&(cooldown.storm_elemental.remains<(cooldown.storm_elemental.duration-30)|!talent.storm_elemental.enabled)&(!talent.icefury.enabled|!buff.icefury.up&!cooldown.icefury.up)
  if not hastalent(ascendance_talent) and not hastalent(storm_elemental_talent) or hastalent(ascendance_talent) and { timeincombat() >= 60 or buffpresent(burst_haste_buff_buff) } and spellcooldown(lava_burst) > 0 and { spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 or not hastalent(storm_elemental_talent) } and { not hastalent(icefury_talent) or not buffpresent(icefury_buff) and not { not spellcooldown(icefury) > 0 } } spell(blood_of_the_enemy)

  unless hastalent(elemental_blast_talent) and { hastalent(master_of_the_elements_talent) and { buffpresent(master_of_the_elements_buff) and maelstrom() < 60 or not buffpresent(master_of_the_elements_buff) } or not hastalent(master_of_the_elements_talent) } and { not { spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) } or azeritetraitrank(natural_harmony_trait) == 3 and buffstacks(wind_gust_buff) < 14 } and spell(elemental_blast)
  {
   #stormkeeper,if=talent.stormkeeper.enabled&(raid_event.adds.count<3|raid_event.adds.in>50)&(!talent.surge_of_power.enabled|buff.surge_of_power.up|maelstrom>=44)
   if hastalent(stormkeeper_talent) and { 0 < 3 or 600 > 50 } and { not hastalent(surge_of_power_talent) or buffpresent(surge_of_power_buff) or maelstrom() >= 44 } spell(stormkeeper)
   #liquid_magma_totem,if=talent.liquid_magma_totem.enabled&(raid_event.adds.count<3|raid_event.adds.in>50)
   if hastalent(liquid_magma_totem_talent) and { 0 < 3 or 600 > 50 } spell(liquid_magma_totem)

   unless buffpresent(stormkeeper_buff) and enemies(tagged=1) < 2 and azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 26 and { buffpresent(master_of_the_elements_buff) and not hastalent(surge_of_power_talent) or buffpresent(surge_of_power_buff) } and spell(lightning_bolt_elemental) or { enemies(tagged=1) > 1 or azeritetraitrank(tectonic_thunder_trait) >= 3 and not hastalent(surge_of_power_talent) and azeritetraitrank(lava_shock_trait) < 1 } and azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 36 + 3 * azeritetraitrank(tectonic_thunder_trait) * enemies(tagged=1) and { not hastalent(surge_of_power_talent) or not target.debuffrefreshable(flame_shock_debuff) or spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 } and { not hastalent(master_of_the_elements_talent) or buffpresent(master_of_the_elements_buff) or spellcooldown(lava_burst) > 0 and maelstrom() >= 92 + 30 * talentpoints(call_the_thunder_talent) } and spell(earthquake) or not buffpresent(surge_of_power_buff) and hastalent(master_of_the_elements_talent) and { buffpresent(master_of_the_elements_buff) or spellcooldown(lava_burst) > 0 and maelstrom() >= 92 + 30 * talentpoints(call_the_thunder_talent) or enemies(tagged=1) < 2 and azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 26 and buffpresent(stormkeeper_buff) and spellcooldown(lava_burst) <= gcd() } and spell(earth_shock) or not hastalent(master_of_the_elements_talent) and not { azeritetraitrank(igneous_potential_trait) > 2 and buffpresent(ascendance_elemental_buff) } and { buffpresent(stormkeeper_buff) or maelstrom() >= 90 + 30 * talentpoints(call_the_thunder_talent) or not { spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) and hastalent(storm_elemental_talent) } and 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } >= 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } } and spell(earth_shock) or hastalent(surge_of_power_talent) and not buffpresent(surge_of_power_buff) and spellcooldown(lava_burst) <= gcd() and { not hastalent(storm_elemental_talent) and not spellcooldown(fire_elemental) > spellcooldownduration(fire_elemental) - 30 or hastalent(storm_elemental_talent) and not spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 } and spell(earth_shock) or spell(lightning_lasso) or spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) and { azeritetraitrank(igneous_potential_trait) < 2 or not buffpresent(lava_surge_buff) and buffpresent(burst_haste_buff_buff) } and spell(lightning_bolt_elemental) or { buffremaining(stormkeeper_buff) < 1.1 * gcd() * buffstacks(stormkeeper_buff) or buffpresent(stormkeeper_buff) and buffpresent(master_of_the_elements_buff) } and spell(lightning_bolt_elemental) or hastalent(icefury_talent) and hastalent(master_of_the_elements_talent) and buffpresent(icefury_buff) and buffpresent(master_of_the_elements_buff) and spell(frost_shock) or buffpresent(ascendance_elemental_buff) and spell(lava_burst) or target.refreshable(flame_shock_debuff) and enemies(tagged=1) > 1 and buffpresent(surge_of_power_buff) and spell(flame_shock) or hastalent(storm_elemental_talent) and not spellcooldown(lava_burst) > 0 and buffpresent(surge_of_power_buff) and { 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } < 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } or 1.16 * { 600 - timeincombat() } - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 1.16 * { 600 - timeincombat() } - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } < 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } } and spell(lava_burst) or not hastalent(storm_elemental_talent) and not spellcooldown(lava_burst) > 0 and buffpresent(surge_of_power_buff) and { 600 - timeincombat() - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 600 - timeincombat() - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } < 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } or 1.16 * { 600 - timeincombat() } - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 1.16 * { 600 - timeincombat() } - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } < 600 - timeincombat() - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 600 - timeincombat() - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } } and spell(lava_burst) or buffpresent(surge_of_power_buff) and spell(lightning_bolt_elemental) or not spellcooldown(lava_burst) > 0 and not hastalent(master_of_the_elements_talent) and spell(lava_burst)
   {
    #icefury,if=talent.icefury.enabled&!(maelstrom>75&cooldown.lava_burst.remains<=0)&(!talent.storm_elemental.enabled|cooldown.storm_elemental.remains<cooldown.storm_elemental.duration-30)
    if hastalent(icefury_talent) and not { maelstrom() > 75 and spellcooldown(lava_burst) <= 0 } and { not hastalent(storm_elemental_talent) or spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 } spell(icefury)

    unless not spellcooldown(lava_burst) > 0 and charges(lava_burst) > talentpoints(echo_of_the_elements_talent_elemental) and spell(lava_burst) or hastalent(icefury_talent) and buffpresent(icefury_buff) and buffremaining(icefury_buff) < 1.1 * gcd() * buffstacks(icefury_buff) and spell(frost_shock) or not spellcooldown(lava_burst) > 0 and spell(lava_burst) or spell(concentrated_flame_essence)
    {
     #reaping_flames
     spell(reaping_flames_essence)
    }
   }
  }
 }
}

AddFunction shamanshortcdpostconditions
{
 { not target.debuffpresent(flame_shock_debuff) or target.debuffremaining(flame_shock_debuff) <= gcd() or hastalent(ascendance_talent) and target.debuffremaining(flame_shock_debuff) < spellcooldown(ascendance_elemental) + baseduration(ascendance_elemental_buff) and spellcooldown(ascendance_elemental) < 4 and { not hastalent(storm_elemental_talent) or hastalent(storm_elemental_talent) and spellcooldown(storm_elemental) < 120 } } and { buffstacks(wind_gust_buff) < 14 or azeritetraitrank(igneous_potential_trait) >= 2 or buffpresent(lava_surge_buff) or not buffpresent(burst_haste_buff_buff) } and not buffpresent(surge_of_power_buff) and spell(flame_shock) or hastalent(elemental_blast_talent) and { hastalent(master_of_the_elements_talent) and { buffpresent(master_of_the_elements_buff) and maelstrom() < 60 or not buffpresent(master_of_the_elements_buff) } or not hastalent(master_of_the_elements_talent) } and { not { spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) } or azeritetraitrank(natural_harmony_trait) == 3 and buffstacks(wind_gust_buff) < 14 } and spell(elemental_blast) or buffpresent(stormkeeper_buff) and enemies(tagged=1) < 2 and azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 26 and { buffpresent(master_of_the_elements_buff) and not hastalent(surge_of_power_talent) or buffpresent(surge_of_power_buff) } and spell(lightning_bolt_elemental) or { enemies(tagged=1) > 1 or azeritetraitrank(tectonic_thunder_trait) >= 3 and not hastalent(surge_of_power_talent) and azeritetraitrank(lava_shock_trait) < 1 } and azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 36 + 3 * azeritetraitrank(tectonic_thunder_trait) * enemies(tagged=1) and { not hastalent(surge_of_power_talent) or not target.debuffrefreshable(flame_shock_debuff) or spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 } and { not hastalent(master_of_the_elements_talent) or buffpresent(master_of_the_elements_buff) or spellcooldown(lava_burst) > 0 and maelstrom() >= 92 + 30 * talentpoints(call_the_thunder_talent) } and spell(earthquake) or not buffpresent(surge_of_power_buff) and hastalent(master_of_the_elements_talent) and { buffpresent(master_of_the_elements_buff) or spellcooldown(lava_burst) > 0 and maelstrom() >= 92 + 30 * talentpoints(call_the_thunder_talent) or enemies(tagged=1) < 2 and azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 26 and buffpresent(stormkeeper_buff) and spellcooldown(lava_burst) <= gcd() } and spell(earth_shock) or not hastalent(master_of_the_elements_talent) and not { azeritetraitrank(igneous_potential_trait) > 2 and buffpresent(ascendance_elemental_buff) } and { buffpresent(stormkeeper_buff) or maelstrom() >= 90 + 30 * talentpoints(call_the_thunder_talent) or not { spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) and hastalent(storm_elemental_talent) } and 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } >= 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } } and spell(earth_shock) or hastalent(surge_of_power_talent) and not buffpresent(surge_of_power_buff) and spellcooldown(lava_burst) <= gcd() and { not hastalent(storm_elemental_talent) and not spellcooldown(fire_elemental) > spellcooldownduration(fire_elemental) - 30 or hastalent(storm_elemental_talent) and not spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 } and spell(earth_shock) or spell(lightning_lasso) or spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) and { azeritetraitrank(igneous_potential_trait) < 2 or not buffpresent(lava_surge_buff) and buffpresent(burst_haste_buff_buff) } and spell(lightning_bolt_elemental) or { buffremaining(stormkeeper_buff) < 1.1 * gcd() * buffstacks(stormkeeper_buff) or buffpresent(stormkeeper_buff) and buffpresent(master_of_the_elements_buff) } and spell(lightning_bolt_elemental) or hastalent(icefury_talent) and hastalent(master_of_the_elements_talent) and buffpresent(icefury_buff) and buffpresent(master_of_the_elements_buff) and spell(frost_shock) or buffpresent(ascendance_elemental_buff) and spell(lava_burst) or target.refreshable(flame_shock_debuff) and enemies(tagged=1) > 1 and buffpresent(surge_of_power_buff) and spell(flame_shock) or hastalent(storm_elemental_talent) and not spellcooldown(lava_burst) > 0 and buffpresent(surge_of_power_buff) and { 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } < 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } or 1.16 * { 600 - timeincombat() } - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 1.16 * { 600 - timeincombat() } - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } < 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } } and spell(lava_burst) or not hastalent(storm_elemental_talent) and not spellcooldown(lava_burst) > 0 and buffpresent(surge_of_power_buff) and { 600 - timeincombat() - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 600 - timeincombat() - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } < 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } or 1.16 * { 600 - timeincombat() } - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 1.16 * { 600 - timeincombat() } - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } < 600 - timeincombat() - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 600 - timeincombat() - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } } and spell(lava_burst) or buffpresent(surge_of_power_buff) and spell(lightning_bolt_elemental) or not spellcooldown(lava_burst) > 0 and not hastalent(master_of_the_elements_talent) and spell(lava_burst) or not spellcooldown(lava_burst) > 0 and charges(lava_burst) > talentpoints(echo_of_the_elements_talent_elemental) and spell(lava_burst) or hastalent(icefury_talent) and buffpresent(icefury_buff) and buffremaining(icefury_buff) < 1.1 * gcd() * buffstacks(icefury_buff) and spell(frost_shock) or not spellcooldown(lava_burst) > 0 and spell(lava_burst) or spell(concentrated_flame_essence) or target.refreshable(flame_shock_debuff) and not buffpresent(surge_of_power_buff) and spell(flame_shock) or hastalent(totem_mastery_talent_elemental) and { totemremaining(totem_mastery_elemental) < 6 or totemremaining(totem_mastery_elemental) < baseduration(ascendance_elemental_buff) + spellcooldown(ascendance_elemental) and spellcooldown(ascendance_elemental) < 15 } and spell(totem_mastery_elemental) or hastalent(icefury_talent) and buffpresent(icefury_buff) and { buffremaining(icefury_buff) < gcd() * 4 * buffstacks(icefury_buff) or buffpresent(stormkeeper_buff) or not hastalent(master_of_the_elements_talent) } and spell(frost_shock) or buffpresent(tectonic_thunder) and not buffpresent(stormkeeper_buff) and enemies(tagged=1) > 1 and spell(chain_lightning_elemental) or spell(lightning_bolt_elemental) or speed() > 0 and target.refreshable(flame_shock_debuff) and spell(flame_shock) or speed() > 0 and target.distance() > 6 and spell(flame_shock) or speed() > 0 and spell(frost_shock)
}

AddFunction shamancdactions
{
 unless { not target.debuffpresent(flame_shock_debuff) or target.debuffremaining(flame_shock_debuff) <= gcd() or hastalent(ascendance_talent) and target.debuffremaining(flame_shock_debuff) < spellcooldown(ascendance_elemental) + baseduration(ascendance_elemental_buff) and spellcooldown(ascendance_elemental) < 4 and { not hastalent(storm_elemental_talent) or hastalent(storm_elemental_talent) and spellcooldown(storm_elemental) < 120 } } and { buffstacks(wind_gust_buff) < 14 or azeritetraitrank(igneous_potential_trait) >= 2 or buffpresent(lava_surge_buff) or not buffpresent(burst_haste_buff_buff) } and not buffpresent(surge_of_power_buff) and spell(flame_shock)
 {
  #ascendance,if=talent.ascendance.enabled&(time>=60|buff.bloodlust.up)&cooldown.lava_burst.remains>0&(cooldown.storm_elemental.remains<(cooldown.storm_elemental.duration-30)|!talent.storm_elemental.enabled)&(!talent.icefury.enabled|!buff.icefury.up&!cooldown.icefury.up)
  if hastalent(ascendance_talent) and { timeincombat() >= 60 or buffpresent(burst_haste_buff_buff) } and spellcooldown(lava_burst) > 0 and { spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 or not hastalent(storm_elemental_talent) } and { not hastalent(icefury_talent) or not buffpresent(icefury_buff) and not { not spellcooldown(icefury) > 0 } } and buffexpires(ascendance_elemental_buff) spell(ascendance_elemental)

  unless hastalent(elemental_blast_talent) and { hastalent(master_of_the_elements_talent) and { buffpresent(master_of_the_elements_buff) and maelstrom() < 60 or not buffpresent(master_of_the_elements_buff) } or not hastalent(master_of_the_elements_talent) } and { not { spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) } or azeritetraitrank(natural_harmony_trait) == 3 and buffstacks(wind_gust_buff) < 14 } and spell(elemental_blast) or hastalent(stormkeeper_talent) and { 0 < 3 or 600 > 50 } and { not hastalent(surge_of_power_talent) or buffpresent(surge_of_power_buff) or maelstrom() >= 44 } and spell(stormkeeper) or hastalent(liquid_magma_totem_talent) and { 0 < 3 or 600 > 50 } and spell(liquid_magma_totem) or buffpresent(stormkeeper_buff) and enemies(tagged=1) < 2 and azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 26 and { buffpresent(master_of_the_elements_buff) and not hastalent(surge_of_power_talent) or buffpresent(surge_of_power_buff) } and spell(lightning_bolt_elemental) or { enemies(tagged=1) > 1 or azeritetraitrank(tectonic_thunder_trait) >= 3 and not hastalent(surge_of_power_talent) and azeritetraitrank(lava_shock_trait) < 1 } and azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 36 + 3 * azeritetraitrank(tectonic_thunder_trait) * enemies(tagged=1) and { not hastalent(surge_of_power_talent) or not target.debuffrefreshable(flame_shock_debuff) or spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 } and { not hastalent(master_of_the_elements_talent) or buffpresent(master_of_the_elements_buff) or spellcooldown(lava_burst) > 0 and maelstrom() >= 92 + 30 * talentpoints(call_the_thunder_talent) } and spell(earthquake) or not buffpresent(surge_of_power_buff) and hastalent(master_of_the_elements_talent) and { buffpresent(master_of_the_elements_buff) or spellcooldown(lava_burst) > 0 and maelstrom() >= 92 + 30 * talentpoints(call_the_thunder_talent) or enemies(tagged=1) < 2 and azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 26 and buffpresent(stormkeeper_buff) and spellcooldown(lava_burst) <= gcd() } and spell(earth_shock) or not hastalent(master_of_the_elements_talent) and not { azeritetraitrank(igneous_potential_trait) > 2 and buffpresent(ascendance_elemental_buff) } and { buffpresent(stormkeeper_buff) or maelstrom() >= 90 + 30 * talentpoints(call_the_thunder_talent) or not { spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) and hastalent(storm_elemental_talent) } and 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } >= 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } } and spell(earth_shock) or hastalent(surge_of_power_talent) and not buffpresent(surge_of_power_buff) and spellcooldown(lava_burst) <= gcd() and { not hastalent(storm_elemental_talent) and not spellcooldown(fire_elemental) > spellcooldownduration(fire_elemental) - 30 or hastalent(storm_elemental_talent) and not spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 } and spell(earth_shock) or spell(lightning_lasso) or spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) and { azeritetraitrank(igneous_potential_trait) < 2 or not buffpresent(lava_surge_buff) and buffpresent(burst_haste_buff_buff) } and spell(lightning_bolt_elemental) or { buffremaining(stormkeeper_buff) < 1.1 * gcd() * buffstacks(stormkeeper_buff) or buffpresent(stormkeeper_buff) and buffpresent(master_of_the_elements_buff) } and spell(lightning_bolt_elemental) or hastalent(icefury_talent) and hastalent(master_of_the_elements_talent) and buffpresent(icefury_buff) and buffpresent(master_of_the_elements_buff) and spell(frost_shock) or buffpresent(ascendance_elemental_buff) and spell(lava_burst) or target.refreshable(flame_shock_debuff) and enemies(tagged=1) > 1 and buffpresent(surge_of_power_buff) and spell(flame_shock) or hastalent(storm_elemental_talent) and not spellcooldown(lava_burst) > 0 and buffpresent(surge_of_power_buff) and { 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } < 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } or 1.16 * { 600 - timeincombat() } - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 1.16 * { 600 - timeincombat() } - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } < 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } } and spell(lava_burst) or not hastalent(storm_elemental_talent) and not spellcooldown(lava_burst) > 0 and buffpresent(surge_of_power_buff) and { 600 - timeincombat() - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 600 - timeincombat() - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } < 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } or 1.16 * { 600 - timeincombat() } - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 1.16 * { 600 - timeincombat() } - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } < 600 - timeincombat() - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 600 - timeincombat() - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } } and spell(lava_burst) or buffpresent(surge_of_power_buff) and spell(lightning_bolt_elemental) or not spellcooldown(lava_burst) > 0 and not hastalent(master_of_the_elements_talent) and spell(lava_burst) or hastalent(icefury_talent) and not { maelstrom() > 75 and spellcooldown(lava_burst) <= 0 } and { not hastalent(storm_elemental_talent) or spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 } and spell(icefury) or not spellcooldown(lava_burst) > 0 and charges(lava_burst) > talentpoints(echo_of_the_elements_talent_elemental) and spell(lava_burst) or hastalent(icefury_talent) and buffpresent(icefury_buff) and buffremaining(icefury_buff) < 1.1 * gcd() * buffstacks(icefury_buff) and spell(frost_shock) or not spellcooldown(lava_burst) > 0 and spell(lava_burst) or spell(concentrated_flame_essence) or spell(reaping_flames_essence) or target.refreshable(flame_shock_debuff) and not buffpresent(surge_of_power_buff) and spell(flame_shock) or hastalent(totem_mastery_talent_elemental) and { totemremaining(totem_mastery_elemental) < 6 or totemremaining(totem_mastery_elemental) < baseduration(ascendance_elemental_buff) + spellcooldown(ascendance_elemental) and spellcooldown(ascendance_elemental) < 15 } and spell(totem_mastery_elemental) or hastalent(icefury_talent) and buffpresent(icefury_buff) and { buffremaining(icefury_buff) < gcd() * 4 * buffstacks(icefury_buff) or buffpresent(stormkeeper_buff) or not hastalent(master_of_the_elements_talent) } and spell(frost_shock)
  {
   #earth_elemental,if=!talent.primal_elementalist.enabled|talent.primal_elementalist.enabled&(cooldown.fire_elemental.remains<(cooldown.fire_elemental.duration-30)&!talent.storm_elemental.enabled|cooldown.storm_elemental.remains<(cooldown.storm_elemental.duration-30)&talent.storm_elemental.enabled)
   if not hastalent(primal_elementalist_talent) or hastalent(primal_elementalist_talent) and { spellcooldown(fire_elemental) < spellcooldownduration(fire_elemental) - 30 and not hastalent(storm_elemental_talent) or spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) } spell(earth_elemental)
  }
 }
}

AddFunction shamancdpostconditions
{
 { not target.debuffpresent(flame_shock_debuff) or target.debuffremaining(flame_shock_debuff) <= gcd() or hastalent(ascendance_talent) and target.debuffremaining(flame_shock_debuff) < spellcooldown(ascendance_elemental) + baseduration(ascendance_elemental_buff) and spellcooldown(ascendance_elemental) < 4 and { not hastalent(storm_elemental_talent) or hastalent(storm_elemental_talent) and spellcooldown(storm_elemental) < 120 } } and { buffstacks(wind_gust_buff) < 14 or azeritetraitrank(igneous_potential_trait) >= 2 or buffpresent(lava_surge_buff) or not buffpresent(burst_haste_buff_buff) } and not buffpresent(surge_of_power_buff) and spell(flame_shock) or hastalent(elemental_blast_talent) and { hastalent(master_of_the_elements_talent) and { buffpresent(master_of_the_elements_buff) and maelstrom() < 60 or not buffpresent(master_of_the_elements_buff) } or not hastalent(master_of_the_elements_talent) } and { not { spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) } or azeritetraitrank(natural_harmony_trait) == 3 and buffstacks(wind_gust_buff) < 14 } and spell(elemental_blast) or hastalent(stormkeeper_talent) and { 0 < 3 or 600 > 50 } and { not hastalent(surge_of_power_talent) or buffpresent(surge_of_power_buff) or maelstrom() >= 44 } and spell(stormkeeper) or hastalent(liquid_magma_totem_talent) and { 0 < 3 or 600 > 50 } and spell(liquid_magma_totem) or buffpresent(stormkeeper_buff) and enemies(tagged=1) < 2 and azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 26 and { buffpresent(master_of_the_elements_buff) and not hastalent(surge_of_power_talent) or buffpresent(surge_of_power_buff) } and spell(lightning_bolt_elemental) or { enemies(tagged=1) > 1 or azeritetraitrank(tectonic_thunder_trait) >= 3 and not hastalent(surge_of_power_talent) and azeritetraitrank(lava_shock_trait) < 1 } and azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 36 + 3 * azeritetraitrank(tectonic_thunder_trait) * enemies(tagged=1) and { not hastalent(surge_of_power_talent) or not target.debuffrefreshable(flame_shock_debuff) or spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 } and { not hastalent(master_of_the_elements_talent) or buffpresent(master_of_the_elements_buff) or spellcooldown(lava_burst) > 0 and maelstrom() >= 92 + 30 * talentpoints(call_the_thunder_talent) } and spell(earthquake) or not buffpresent(surge_of_power_buff) and hastalent(master_of_the_elements_talent) and { buffpresent(master_of_the_elements_buff) or spellcooldown(lava_burst) > 0 and maelstrom() >= 92 + 30 * talentpoints(call_the_thunder_talent) or enemies(tagged=1) < 2 and azeritetraitrank(lava_shock_trait) * buffstacks(lava_shock_buff) < 26 and buffpresent(stormkeeper_buff) and spellcooldown(lava_burst) <= gcd() } and spell(earth_shock) or not hastalent(master_of_the_elements_talent) and not { azeritetraitrank(igneous_potential_trait) > 2 and buffpresent(ascendance_elemental_buff) } and { buffpresent(stormkeeper_buff) or maelstrom() >= 90 + 30 * talentpoints(call_the_thunder_talent) or not { spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) and hastalent(storm_elemental_talent) } and 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } >= 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } } and spell(earth_shock) or hastalent(surge_of_power_talent) and not buffpresent(surge_of_power_buff) and spellcooldown(lava_burst) <= gcd() and { not hastalent(storm_elemental_talent) and not spellcooldown(fire_elemental) > spellcooldownduration(fire_elemental) - 30 or hastalent(storm_elemental_talent) and not spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 } and spell(earth_shock) or spell(lightning_lasso) or spellcooldown(storm_elemental) > spellcooldownduration(storm_elemental) - 30 and hastalent(storm_elemental_talent) and { azeritetraitrank(igneous_potential_trait) < 2 or not buffpresent(lava_surge_buff) and buffpresent(burst_haste_buff_buff) } and spell(lightning_bolt_elemental) or { buffremaining(stormkeeper_buff) < 1.1 * gcd() * buffstacks(stormkeeper_buff) or buffpresent(stormkeeper_buff) and buffpresent(master_of_the_elements_buff) } and spell(lightning_bolt_elemental) or hastalent(icefury_talent) and hastalent(master_of_the_elements_talent) and buffpresent(icefury_buff) and buffpresent(master_of_the_elements_buff) and spell(frost_shock) or buffpresent(ascendance_elemental_buff) and spell(lava_burst) or target.refreshable(flame_shock_debuff) and enemies(tagged=1) > 1 and buffpresent(surge_of_power_buff) and spell(flame_shock) or hastalent(storm_elemental_talent) and not spellcooldown(lava_burst) > 0 and buffpresent(surge_of_power_buff) and { 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } < 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } or 1.16 * { 600 - timeincombat() } - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 1.16 * { 600 - timeincombat() } - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } < 600 - timeincombat() - spellcooldown(storm_elemental) - spellcooldownduration(storm_elemental) * { { 600 - timeincombat() - spellcooldown(storm_elemental) } / spellcooldownduration(storm_elemental) } } and spell(lava_burst) or not hastalent(storm_elemental_talent) and not spellcooldown(lava_burst) > 0 and buffpresent(surge_of_power_buff) and { 600 - timeincombat() - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 600 - timeincombat() - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } < 30 * { 1 + { azeritetraitrank(echo_of_the_elementals_trait) >= 2 } } or 1.16 * { 600 - timeincombat() } - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 1.16 * { 600 - timeincombat() } - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } < 600 - timeincombat() - spellcooldown(fire_elemental) - spellcooldownduration(fire_elemental) * { { 600 - timeincombat() - spellcooldown(fire_elemental) } / spellcooldownduration(fire_elemental) } } and spell(lava_burst) or buffpresent(surge_of_power_buff) and spell(lightning_bolt_elemental) or not spellcooldown(lava_burst) > 0 and not hastalent(master_of_the_elements_talent) and spell(lava_burst) or hastalent(icefury_talent) and not { maelstrom() > 75 and spellcooldown(lava_burst) <= 0 } and { not hastalent(storm_elemental_talent) or spellcooldown(storm_elemental) < spellcooldownduration(storm_elemental) - 30 } and spell(icefury) or not spellcooldown(lava_burst) > 0 and charges(lava_burst) > talentpoints(echo_of_the_elements_talent_elemental) and spell(lava_burst) or hastalent(icefury_talent) and buffpresent(icefury_buff) and buffremaining(icefury_buff) < 1.1 * gcd() * buffstacks(icefury_buff) and spell(frost_shock) or not spellcooldown(lava_burst) > 0 and spell(lava_burst) or spell(concentrated_flame_essence) or spell(reaping_flames_essence) or target.refreshable(flame_shock_debuff) and not buffpresent(surge_of_power_buff) and spell(flame_shock) or hastalent(totem_mastery_talent_elemental) and { totemremaining(totem_mastery_elemental) < 6 or totemremaining(totem_mastery_elemental) < baseduration(ascendance_elemental_buff) + spellcooldown(ascendance_elemental) and spellcooldown(ascendance_elemental) < 15 } and spell(totem_mastery_elemental) or hastalent(icefury_talent) and buffpresent(icefury_buff) and { buffremaining(icefury_buff) < gcd() * 4 * buffstacks(icefury_buff) or buffpresent(stormkeeper_buff) or not hastalent(master_of_the_elements_talent) } and spell(frost_shock) or buffpresent(tectonic_thunder) and not buffpresent(stormkeeper_buff) and enemies(tagged=1) > 1 and spell(chain_lightning_elemental) or spell(lightning_bolt_elemental) or speed() > 0 and target.refreshable(flame_shock_debuff) and spell(flame_shock) or speed() > 0 and target.distance() > 6 and spell(flame_shock) or speed() > 0 and spell(frost_shock)
}
]]

		OvaleScripts:RegisterScript("SHAMAN", "elemental", name, desc, code, "script")
	end
end
